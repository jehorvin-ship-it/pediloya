<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finalizar Pedido - PediloYa</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="auth.js"></script> <link rel="stylesheet" href="styles.css">
  
  <style>
    ..payment-method {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: #F5F5F5;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 1rem;
    }
    .payment-method.selected {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px var(--primary);
    }
    .payment-method .icon { font-size: 2rem; }
    .payment-method .info p { margin: 0; font-weight: 600; }
    .payment-method .info span { margin: 0; font-size: 0.9rem; color: var(--muted); }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
      </a>
    </div>
  </header>

  <main class="container" style="max-width: 500px;">
    <a class="back-link" href="javascript:history.back()">‚Üê Volver al negocio</a>
    <h1>Finalizar Pedido</h1>
    
    <div id="productArea" class="biz-row" style="flex-direction: row; align-items: center; ...">
        <img id="imgProd" src="" alt="Imagen producto" ...>
        <div>
            <h3 id="titulo" ...></h3>
            <p>Precio: <strong>C$ <span id="price">0.00</span></strong></p>
        </div>
    </div>
    <div class="input-control" style="margin-top: 1rem;">
        <label for="cantidad">Cantidad</label>
        <div class="row" ...>
          <button id="dec" ...>-</button>
          <span id="qty" ...>1</span>
          <button id="inc" ...>+</button>
        </div>
    </div>
    <p style="text-align: right; font-size: 1.2rem; ...">Total: <strong>C$ <span id="total">0.00</span></strong></p>

    <div id="verification-container" style="display:none;">
        <h2 style="font-size: 1.2rem; margin-top: 2rem;">Inicia Sesi√≥n para Comprar</h2>
        <p class="muted">Verifica tu n√∫mero para continuar con el pedido. Esto crear√° tu cuenta.</p>
        
        <div class="input-control">
          <label for="celular">Tu N√∫mero de Celular (Ej: 88997766)</label>
          <div class="row" style="gap: 0.5rem;">
              <span style="padding: 0.8rem; ...">+505</span>
              <input id="celular" name="celular" type="tel" placeholder="88997766" required ... />
          </div>
        </div>
        <button id="send-otp-btn" type="button" class="btn" ...>Enviar c√≥digo SMS</button>
        <p id="send-otp-error" ...></p>
        <div id="recaptcha-container" ...></div>
    </div>

    <div id="otp-container" style="display:none; ...">
        <div class="input-control">
          <label for="otp-code">C√≥digo de 6 d√≠gitos</label>
          <input id="otp-code" type="tel" placeholder="123456" required />
        </div>
        <button id="confirm-otp-btn" type="button" class="btn" ...>Verificar y Continuar</button>
        <p id="confirm-otp-error" ...></p>
    </div>

    <form id="checkoutForm" autocomplete="off" style="display:none;">
      <h2 style="font-size: 1.2rem; margin-top: 2rem;">Tus Datos de Entrega</h2>
      <p id="checkout-welcome" class="muted">¬°Est√°s comprando como ...!</p>

      <div class="input-control">
        <label for="nombre">Tu Nombre Completo</label>
        <input id="nombre" name="nombre" type="text" placeholder="Escribe tu nombre" required />
      </div>
      <div class="input-control">
        <label for="lugar">Barrio o Zona</label>
        <select id="lugar" name="lugar" required>
          <option>Betania</option>
          <option>Buenos Aires</option>
          <option>Punta Fria</option>
          <option>Punta Caliente</option>
        </select>
      </div>
      <div class="input-control">
       <label for="barrio">Direcci√≥n Exacta o Referencia</label>
       <input id="barrio" name="barrio" type="text" ... required />
      </div>

      <h2 style="font-size: 1.2rem; margin-top: 2rem;">M√©todo de Pago</h2>
      <div class="payment-method selected">
        <span class="icon">üíµ</span>
        <div class="info">
          <p>Efectivo contra entrega</p>
          <span>Pagar√°s al repartidor cuando recibas tu pedido.</span>
        </div>
      </div>

      <button id="verificar" type="submit" class="btn" ...>Confirmar Pedido</button>
    </form>

    <div id="notification" style="display:none;margin-top:1.5rem; text-align: center;"></div>
  </main>

  <footer class="site-footer">¬© PediloYa</footer>

  <script src="lib.js"></script>
  <script>
    // --- ¬°YA NO NECESITAMOS LA CONFIGURACI√ìN DE FIREBASE AQU√ç! ---
    // Est√° en auth.js
    
    // --- Variables Globales ---
    let appVerifier;
    let confirmationResult;
    let producto, negocio, price, qty = 1;
    let authenticatedUserPhone = null; // ¬°NUEVA! Guardar√° el tel√©fono del usuario logueado

    // --- Selectores del DOM (sin cambios) ---
    const checkoutForm = document.getElementById('checkoutForm');
    const verificationContainer = document.getElementById('verification-container');
    const otpContainer = document.getElementById('otp-container');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const confirmOtpBtn = document.getElementById('confirm-otp-btn');
    const celularInput = document.getElementById('celular');
    const sendOtpError = document.getElementById('send-otp-error');
    const confirmOtpError = document.getElementById('confirm-otp-error');
    const notificationDiv = document.getElementById('notification');

    // --- ¬°L√ìGICA DE CARGA DE P√ÅGINA (MUY MODIFICADA)! ---
    (async () => {
      
      // 1. Verificamos si el usuario ya est√° logueado
      const user = await getCurrentUser(); // De auth.js

      if (user) {
        // --- CASO 1: USUARIO S√ç EST√Å LOGUEADO ---
        console.log("Usuario ya logueado:", user.phoneNumber);
        authenticatedUserPhone = user.phoneNumber.replace('+505', '');
        
        // Ocultamos los formularios de login
        verificationContainer.style.display = 'none';
        otpContainer.style.display = 'none';
        
        // Mostramos el formulario final
        checkoutForm.style.display = 'block';
        document.getElementById('checkout-welcome').textContent = `¬°Est√°s comprando como ${authenticatedUserPhone}!`;

      } else {
        // --- CASO 2: USUARIO NO EST√Å LOGUEADO ---
        console.log("Usuario no logueado, mostrando verificaci√≥n.");
        verificationContainer.style.display = 'block';
        
        // Preparamos el reCAPTCHA para el login
        try {
          appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible'
          });
        } catch (e) { console.error("Error inicializando reCAPTCHA", e); }
      }
      
      // 2. Cargamos los datos del producto (l√≥gica original)
      try {
        const productId = localStorage.getItem('productoSeleccionadoID');
        const businessId = localStorage.getItem('negocioSeleccionadoID');
        if (!productId || !businessId) throw new Error("No se seleccion√≥ producto.");
        const negocios = await fetchSheetByGid(GID_NEGOCIOS);
        const productos = await fetchSheetByGid(GID_PRODUCTOS);
        producto = productos.find(p => p.ID === productId);
        negocio = negocios.find(b => b.ID === businessId);
        if (!producto || !negocio) throw new Error("Producto o negocio no encontrado.");
        document.getElementById('titulo').textContent = producto.Nombre;
        document.getElementById('imgProd').src = producto.Imagen || negocio.Imagen || '';
        price = (producto.PrecioOferta && producto.PrecioOferta !== '') ? Number(producto.PrecioOferta) : Number(producto.Precio || 0);
        document.getElementById('price').textContent = price.toFixed(2);
        const totalEl = document.getElementById('total');
        const qtyEl = document.getElementById('qty');
        function updateTotal() {
          qtyEl.textContent = qty;
          totalEl.textContent = (price * qty).toFixed(2);
        }
        updateTotal();
        document.getElementById('inc').addEventListener('click', () => { qty++; updateTotal(); });
        document.getElementById('dec').addEventListener('click', () => { if (qty>1) { qty--; updateTotal(); } });
      } catch (err) {
        console.error(err);
        document.querySelector('main').innerHTML = `<h1>Error</h1><p>${err.message}. Por favor, vuelve a intentarlo.</p><a href="index.html" class="btn">Volver a Inicio</a>`;
      }
    })();

    // --- L√≥gica de Verificaci√≥n (¬°MODIFICADA!) ---
    // (Ahora esta l√≥gica es para INICIAR SESI√ìN)

    // PASO 1: Enviar SMS
    sendOtpBtn.addEventListener('click', async () => {
      // (Esta funci√≥n es id√©ntica a la de mis-pedidos.html)
      const phoneNumber = celularInput.value.trim();
      if (phoneNumber.length < 8) {
        sendOtpError.textContent = 'Por favor, introduce un n√∫mero de 8 d√≠gitos.';
        return sendOtpError.style.display = 'block';
      }
      const fullPhoneNumber = `+505${phoneNumber}`;
      sendOtpBtn.disabled = true;
      sendOtpBtn.textContent = 'Enviando SMS...';
      sendOtpError.style.display = 'none';
      try {
        confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, appVerifier);
        verificationContainer.style.display = 'none';
        otpContainer.style.display = 'block';
        document.getElementById('otp-code').focus();
      } catch (error) {
        console.error("Error al enviar SMS:", error);
        sendOtpError.textContent = `Error: ${error.message}. Revisa el n√∫mero.`;
        sendOtpError.style.display = 'block';
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Enviar c√≥digo SMS';
      }
    });

    // PASO 2: Confirmar C√≥digo (¬°MODIFICADO!)
    confirmOtpBtn.addEventListener('click', async () => {
      const code = document.getElementById('otp-code').value.trim();
      if (code.length < 6) {
        confirmOtpError.textContent = 'El c√≥digo debe tener 6 d√≠gitos.';
        return confirmOtpError.style.display = 'block';
      }
      confirmOtpBtn.disabled = true;
      confirmOtpBtn.textContent = 'Verificando...';
      confirmOtpError.style.display = 'none';

      try {
        await confirmationResult.confirm(code);
        
        // ¬°√âXITO! Usuario logueado en Firebase
        confirmOtpBtn.textContent = '¬°Verificado!';
        otpContainer.style.display = 'none';
        checkoutForm.style.display = 'block';
        
        // --- ¬°YA NO USAMOS localStorage.setItem! ---
        // Guardamos el tel√©fono en nuestra variable global
        authenticatedUserPhone = celularInput.value.trim();
        document.getElementById('checkout-welcome').textContent = `¬°Est√°s comprando como ${authenticatedUserPhone}!`;

      } catch (error) {
        console.error("Error al verificar c√≥digo:", error);
        confirmOtpError.textContent = 'C√≥digo incorrecto. Intenta de nuevo.';
        confirmOtpError.style.display = 'block';
        confirmOtpBtn.disabled = false;
        confirmOtpBtn.textContent = 'Verificar C√≥digo';
      }
    });

    // --- PASO 3: Enviar Pedido (¬°MODIFICADO!) ---
    checkoutForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const boton = document.getElementById('verificar');
      boton.disabled = true;
      boton.textContent = 'Enviando...';

      try {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3Z-ixBkV_0Eh7sLDL8clpcsnKttk3PRixP-wrsNO0yNOoaOvLVj1UnZH7xY5caCtn/exec";
        const ordenId = Math.floor(Math.random() * 90000) + 10000;
        
        // --- ¬°CAMBIO CLAVE! ---
        // Usamos el tel√©fono autenticado en lugar de leer el input
        if (!authenticatedUserPhone) {
            throw new Error("Error de autenticaci√≥n. No se encontr√≥ el n√∫mero de tel√©fono.");
        }

        const payload = {
          ordenId: ordenId,
          cliente: {
            nombre: document.getElementById('nombre').value.trim(),
            celular: authenticatedUserPhone, // <-- ¬°USAMOS EL N√öMERO AUTENTICADO!
            lugar: document.getElementById('lugar').value,
            barrio: document.getElementById('barrio').value.trim()
          },
          negocio: { id: negocio.ID, nombre: negocio.NombreNegocio },
          producto: {
            nombre: producto.Nombre,
            qty: qty,
            precio: price.toFixed(2),
            total: (price * qty).toFixed(2),
          },
          metodoPago: 'Efectivo contra entrega' 
        };

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'addOrder', payload: payload })
        });
        const result = await response.json();

        if (result.status === 'success') {
          notificationDiv.style.display = 'block';
          notificationDiv.innerHTML = `<h3>Pedido enviado con √©xito ‚úÖ</h3>
            <p><b>N√∫mero de orden:</b> ${ordenId}</p>
            <p>El negocio ha sido notificado. Puedes ver el estado en "Mis Pedidos".</p>
            <a href="seguimiento.html?id=${ordenId}" class="btn" style="margin-top: 1rem;">Seguir mi Pedido en Vivo</a>`;
          
          checkoutForm.style.display = 'none';
          document.getElementById('productArea').style.display = 'none';
        } else {
          throw new Error(result.message || 'Error desconocido del servidor.');
        }
      } catch (err) {
        alert(`Ocurri√≥ un error al procesar el pedido: ${err.message}.`);
        boton.disabled = false;
        boton.textContent = 'Confirmar Pedido';
      }
    });
  </script>
</body>
</html>
