<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Solicitar un Mandado - PediloYa</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script> 
  <script src="auth.js"></script> 
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Estilos existentes para payment-method (sin cambios) */
    .payment-method { /* ... */ }
    .payment-method.selected { /* ... */ }
    .payment-method .icon { /* ... */ }
    .payment-method .info p { /* ... */ }
    .payment-method .info span { /* ... */ }
    #recaptcha-container div { /* ... */ }

    /* --- ¬°NUEVOS ESTILOS PARA CATEGOR√çAS DE MANDADO! --- */
    .mandado-category-list {
      list-style: none;
      padding: 0;
      margin: 1.5rem 0;
    }
    .mandado-category-item {
      display: flex;
      align-items: center;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 0.75rem;
      padding: 0.8rem 1rem;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .mandado-category-item:hover {
      border-color: #ddd;
    }
    .mandado-category-item input[type="radio"] {
      margin-right: 1rem;
      transform: scale(1.2); /* Hacer radio button un poco m√°s grande */
    }
    .mandado-category-item label {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer; /* Hacer toda la etiqueta clicable */
    }
    .mandado-category-item label span {
      font-weight: 500;
    }
    .mandado-category-item label strong {
      color: var(--primary); /* Precio en rojo */
      font-weight: 600;
    }
    .mandado-category-item .details-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.5rem; /* Tama√±o del '+' */
      padding: 0 0.5rem;
      margin-left: 0.5rem;
      cursor: pointer;
      line-height: 1;
    }
    .mandado-category-item.selected {
       border-color: var(--primary);
       box-shadow: 0 0 0 2px rgba(239, 51, 64, 0.2);
    }

    /* --- Estilos para el Modal de Detalles --- */
    .modal {
      display: none; position: fixed; z-index: 1001; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
      align-items: center; justify-content: center; /* Centrar modal */
    }
    /* A√±adir display: flex a .modal cuando se muestra */
     .modal.visible { 
         display: flex;
     }
    .modal-content {
      background-color: #fefefe; padding: 20px; border: 1px solid #888;
      width: 90%; max-width: 450px; border-radius: var(--radius);
      position: relative; /* Para el bot√≥n de cerrar */
    }
    .modal-header { padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem;}
    .modal-header h2 { font-size: 1.2rem; margin: 0; }
    .close-button {
      position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 28px;
      font-weight: bold; cursor: pointer; border: none; background: none;
    }
    .modal-body p { margin-bottom: 0.5rem; text-align: left; }
    .modal-body ul { text-align: left; margin-left: 1.5rem; margin-bottom: 1rem;}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
      </a>
      <h2 style="margin-left: 1rem; font-size: 1.2rem; margin-bottom: 0;">Solicitar Mandado</h2>
    </div>
  </header>

  <main class="container" style="max-width: 600px;">
    <a class="back-link" href="index.html">‚Üê Volver a Inicio</a>

    <div id="verification-container" style="display:none;">
        <h2 style="font-size: 1.2rem; margin-top: 2rem;">Inicia Sesi√≥n para Solicitar</h2>
        <p class="muted">Verifica tu n√∫mero para continuar. Esto crear√° tu cuenta.</p>
        <div class="input-control">
          <label for="celular">Tu N√∫mero de Celular (Ej: 88997766)</label>
          <div class="row" style="gap: 0.5rem;">
              <span style="padding: 0.8rem; background: #F5F5F5; border-radius: 8px; font-weight: 600;">+505</span>
              <input id="celular" name="celular" type="tel" placeholder="88997766" required style="flex: 1;" />
          </div>
        </div>
        <div id="recaptcha-container"></div> 
        <button id="send-otp-btn" type="button" class="btn" style="width: 100%; padding: 0.9rem;">Enviar c√≥digo SMS</button>
        <p id="send-otp-error" style="color:#b94a48; margin-top: 1rem; display: none;"></p>
    </div>
    <div id="otp-container" style="display:none; margin-top: 1.5rem;">
        <div class="input-control">
          <label for="otp-code">C√≥digo de 6 d√≠gitos</label>
          <input id="otp-code" type="tel" placeholder="123456" required />
        </div>
        <button id="confirm-otp-btn" type="button" class="btn" style="width: 100%; padding: 0.9rem;">Verificar y Continuar</button>
        <p id="confirm-otp-error" style="color:#b94a48; margin-top: 1rem; display: none;"></p>
    </div>

    <form id="mandadoForm" autocomplete="off" style="display:none;">
      <p id="mandado-welcome" class="muted" style="margin-top: 2rem;">¬°Est√°s solicitando como ...!</p>

      <h2 style="font-size: 1.2rem; margin-top: 2rem;">Elige el Tipo de Mandado</h2>
      <ul class="mandado-category-list">
        <li class="mandado-category-item" data-category="Documentos">
          <input type="radio" id="cat-doc" name="mandado_category" value="Documentos" data-price="35">
          <label for="cat-doc">
            <span>üìÑ Documentos (Sobre)</span>
            <strong>C$ 35</strong>
          </label>
          <button type="button" class="details-btn" data-details-for="Documentos" title="Ver detalles">+</button>
        </li>
        <li class="mandado-category-item" data-category="Paquete Peque√±o">
          <input type="radio" id="cat-pack" name="mandado_category" value="Paquete Peque√±o" data-price="55">
          <label for="cat-pack">
            <span>üì¶ Paquete Peque√±o</span>
            <strong>C$ 55</strong>
          </label>
          <button type="button" class="details-btn" data-details-for="Paquete Peque√±o" title="Ver detalles">+</button>
        </li>
        <li class="mandado-category-item" data-category="Compra Expr√©s">
          <input type="radio" id="cat-buy" name="mandado_category" value="Compra Expr√©s" data-price="65">
          <label for="cat-buy">
            <span>üõí Compra Expr√©s (1-3 √≠tems)</span>
            <strong>C$ 65 (+ Productos)</strong>
          </label>
          <button type="button" class="details-btn" data-details-for="Compra Expr√©s" title="Ver detalles">+</button>
        </li>
        <li class="mandado-category-item" data-category="Pago de Recibo">
          <input type="radio" id="cat-pay" name="mandado_category" value="Pago de Recibo" data-price="45">
          <label for="cat-pay">
            <span>üßæ Pago de Recibo (1 lugar)</span>
            <strong>C$ 45 (+ Recibo)</strong>
          </label>
          <button type="button" class="details-btn" data-details-for="Pago de Recibo" title="Ver detalles">+</button>
        </li>
         <li class="mandado-category-item" data-category="Otro">
          <input type="radio" id="cat-other" name="mandado_category" value="Otro">
          <label for="cat-other">
            <span>‚ùì Otro / Personalizado</span>
            <strong>(Requiere Cotizaci√≥n)</strong>
          </label>
          <button type="button" class="details-btn" data-details-for="Otro" title="Ver detalles">+</button>
        </li>
      </ul>
      <div class="input-control">
        <label for="descripcion">Detalles Espec√≠ficos del Mandado</label>
        <textarea id="descripcion" placeholder="Ej: Recoger sobre en oficina X, entregar en Y. // Pagar recibo de luz #12345 con C$500 exactos. // Comprar 1 Coca-Cola 2L y 1 pan de molde." required></textarea>
      </div>
      <div class="input-control">
        <label for="origen">Direcci√≥n de Origen (si aplica)</label>
        <input id="origen" type="text" placeholder="Ej: Oficina de Enacal, frente al parque">
      </div>
      <div class="input-control">
        <label for="destino">Direcci√≥n de Entrega / Destino Final</label>
        <input id="destino" type="text" placeholder="Tu direcci√≥n para entregarte o el destino final del mandado" required>
      </div>

      <h2 style="font-size: 1.2rem; margin-top: 2rem;">Tus Datos de Contacto</h2>
      <div class="input-control">
        <label for="nombre">Tu Nombre Completo</label>
        <input id="nombre" type="text" placeholder="Escribe tu nombre" required />
      </div>

      <h2 style="font-size: 1.2rem; margin-top: 2rem;">M√©todo de Pago</h2>
      <div class="payment-method selected">
        <span class="icon">üíµ</span>
        <div class="info">
          <p>Efectivo contra entrega</p>
          <span id="payment-details">Pagar√°s la tarifa (y el costo de productos si aplica) al repartidor.</span>
        </div>
      </div>

      <button id="solicitarBtn" type="submit" class="btn" style="width: 100%; padding: 0.9rem; margin-top: 2rem;">Enviar Solicitud</button>
    </form>

    <div id="notification" style="display:none;margin-top:1.5rem; text-align: center;"></div>
  </main>

  <footer class="site-footer">¬© PediloYa</footer>

  <nav class="navbar-bottom">
     <a href="index.html" class="nav-link active" data-page="index">...</a> 
      <a href="categoria.html?cat=Mercado" class="nav-link" data-page="mercado">...</a>
      <a href="promociones.html" class="nav-link" data-page="promociones">...</a>
      <a href="mis-pedidos.html" class="nav-link" data-page="pedidos">...</a>
      <a href="perfil.html" class="nav-link" data-page="perfil">...</a>
  </nav>

  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="closeDetailsModal()">&times;</button>
      <div class="modal-header">
        <h2 id="modalCategoryTitle">Detalles</h2>
      </div>
      <div id="modalCategoryDetails" class="modal-body">
        <p>...</p>
      </div>
    </div>
  </div>
  <script src="lib.js"></script>
  <script>
    // --- L√ìGICA DE LA P√ÅGINA DE MANDADO ---

    // Variables Globales (igual que checkout)
    let appVerifier = null;
    let confirmationResult;
    let authenticatedUserPhone = null; 
    let blockTimerInterval = null;
    let blockSecondsRemaining = 60; 

    // Selectores del DOM
    const mandadoForm = document.getElementById('mandadoForm');
    const verificationContainer = document.getElementById('verification-container');
    const otpContainer = document.getElementById('otp-container');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const confirmOtpBtn = document.getElementById('confirm-otp-btn');
    const celularInput = document.getElementById('celular');
    const sendOtpError = document.getElementById('send-otp-error');
    const confirmOtpError = document.getElementById('confirm-otp-error');
    const notificationDiv = document.getElementById('notification');
    const recaptchaContainer = document.getElementById('recaptcha-container'); 
    const categoryItems = document.querySelectorAll('.mandado-category-item'); // Seleccionar items de categor√≠a
    const paymentDetailsSpan = document.getElementById('payment-details'); // Span de detalles de pago

    // --- L√ìGICA DE CARGA DE P√ÅGINA ---
    (async () => {
      const user = await getCurrentUser(); 
      if (user) {
        authenticatedUserPhone = user.phoneNumber.replace('+505', '');
        verificationContainer.style.display = 'none';
        otpContainer.style.display = 'none';
        mandadoForm.style.display = 'block';
        document.getElementById('mandado-welcome').textContent = `¬°Est√°s solicitando como ${authenticatedUserPhone}!`;
      } else {
        verificationContainer.style.display = 'block';
        try {
          recaptchaContainer.innerHTML = ''; 
          appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible', // Invisible aqu√≠ tambi√©n
             'callback': (response) => { console.log("reCAPTCHA invisible verificado."); },
             'expired-callback': () => {
                console.warn("reCAPTCHA invisible expir√≥.");
                sendOtpError.textContent = "La verificaci√≥n expir√≥. Intenta enviar el SMS de nuevo.";
                sendOtpError.style.display = 'block';
                sendOtpBtn.disabled = false;
                sendOtpBtn.textContent = 'Enviar c√≥digo SMS';
                if (appVerifier) { appVerifier.clear(); appVerifier = null; console.log("appVerifier limpiado."); }
             }
          });
          await appVerifier.render().catch(renderError => {
             console.error("Error al renderizar reCAPTCHA invisible:", renderError);
             sendOtpError.textContent = `Error al mostrar reCAPTCHA: ${renderError.message}`;
             sendOtpError.style.display = 'block';
          });
          console.log("reCAPTCHA invisible renderizado OK.");
        } catch (e) { 
            console.error("Error cr√≠tico inicializando reCAPTCHA invisible:", e); 
            sendOtpError.textContent = `Error cr√≠tico al iniciar reCAPTCHA: ${e.message}`;
            sendOtpError.style.display = 'block';
        }
      }
    })();

    // --- L√ìGICA DE VERIFICACI√ìN CON MANEJO DE BLOQUEO (igual que checkout) ---
    sendOtpBtn.addEventListener('click', async () => { /* ... (c√≥digo igual) ... */ });
    confirmOtpBtn.addEventListener('click', async () => { /* ... (c√≥digo igual, al confirmar muestra mandadoForm) ... */ });

    // --- ¬°NUEVO! L√ìGICA DE SELECCI√ìN DE CATEGOR√çA ---
    categoryItems.forEach(item => {
        const radio = item.querySelector('input[type="radio"]');
        const label = item.querySelector('label');
        const button = item.querySelector('.details-btn');

        // Seleccionar al hacer clic en cualquier parte del item (excepto el bot√≥n '+')
        item.addEventListener('click', (e) => {
             if (e.target !== button && !button.contains(e.target)) { // No activar si se hace clic en '+'
                if (!radio.checked) {
                    radio.checked = true;
                    updateCategorySelection();
                }
             }
        });

        // Abrir modal al hacer clic en '+'
        button.addEventListener('click', (e) => {
             e.stopPropagation(); // Evitar que el clic active la selecci√≥n del radio
             openDetailsModal(item.dataset.category);
        });
    });

    function updateCategorySelection() {
         categoryItems.forEach(item => {
             const radio = item.querySelector('input[type="radio"]');
             item.classList.toggle('selected', radio.checked);
         });
         // Actualizar texto de detalles de pago (opcional)
         const selectedRadio = document.querySelector('input[name="mandado_category"]:checked');
         if (selectedRadio && selectedRadio.value === 'Otro') {
             paymentDetailsSpan.textContent = "El precio ser√° cotizado por el repartidor.";
         } else if (selectedRadio && selectedRadio.value === 'Compra Expr√©s') {
             paymentDetailsSpan.textContent = `Pagar√°s ${selectedRadio.dataset.price} + costo de productos al repartidor.`;
         } else if (selectedRadio && selectedRadio.value === 'Pago de Recibo') {
             paymentDetailsSpan.textContent = `Pagar√°s ${selectedRadio.dataset.price} + monto del recibo al repartidor.`;
         } else if (selectedRadio) {
             paymentDetailsSpan.textContent = `Pagar√°s la tarifa de C$ ${selectedRadio.dataset.price} al repartidor.`;
         } else {
              paymentDetailsSpan.textContent = "Pagar√°s la tarifa al repartidor.";
         }
    }
    // Llamar una vez por si hay valor inicial (aunque no deber√≠a)
    updateCategorySelection();
    // --- FIN L√ìGICA DE SELECCI√ìN ---


    // --- ¬°NUEVO! L√ìGICA DEL MODAL DE DETALLES ---
    const detailsModal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalCategoryTitle');
    const modalDetails = document.getElementById('modalCategoryDetails');

    // Contenido de los detalles (ajusta seg√∫n tus definiciones)
    const categoryDetailsContent = {
        'Documentos': `
            <p><strong>Incluye:</strong></p>
            <ul>
                <li>Recoger y/o entregar 1 sobre tama√±o carta o similar.</li>
                <li>Un solo punto de recogida/entrega dentro de la zona est√°ndar.</li>
            </ul>
            <p><strong>Limitaciones:</strong></p>
            <ul>
                <li>No incluye esperas largas (m√°s de 5 min).</li>
            </ul>`,
        'Paquete Peque√±o': `
            <p><strong>Incluye:</strong></p>
            <ul>
                <li>Recoger y/o entregar 1 paquete (tama√±o caja de zapatos, hasta 2-3 kg).</li>
                <li>Un solo punto de recogida/entrega.</li>
            </ul>
            <p><strong>Limitaciones:</strong></p>
            <ul>
                <li>No art√≠culos fr√°giles sin embalaje.</li>
                <li>No art√≠culos de muy alto valor.</li>
            </ul>`,
         'Compra Expr√©s': `
            <p><strong>Incluye:</strong></p>
            <ul>
                <li>Ir a <strong>UNA</strong> pulper√≠a/farmacia/conveniencia cercana.</li>
                <li>Comprar <strong>hasta 3 art√≠culos</strong> comunes y espec√≠ficos.</li>
                <li>Repartidor paga y t√∫ reembolsas productos + tarifa de C$ ${document.querySelector('#cat-buy')?.dataset.price || '65'}.</li>
            </ul>
            <p><strong>Limitaciones:</strong></p>
            <ul>
                <li>M√°ximo C$ 500 en productos.</li>
                <li>Art√≠culos claramente definidos.</li>
                <li>Un solo lugar de compra.</li>
            </ul>`,
         'Pago de Recibo': `
             <p><strong>Incluye:</strong></p>
             <ul>
                 <li>Ir a <strong>UN</strong> punto de pago.</li>
                 <li>Pagar <strong>un (1)</strong> recibo/factura.</li>
                 <li>Debes proporcionar el dinero exacto o confirmar monto para reembolso + tarifa de C$ ${document.querySelector('#cat-pay')?.dataset.price || '45'}.</li>
             </ul>
             <p><strong>Limitaciones:</strong></p>
             <ul>
                 <li>No incluye largas filas (espera razonable < 15-20 min).</li>
                 <li>Un solo lugar de pago.</li>
             </ul>`,
         'Otro': `
             <p>Selecciona esta opci√≥n si tu mandado no encaja en las categor√≠as anteriores, por ejemplo:</p>
             <ul>
                 <li>M√∫ltiples paradas.</li>
                 <li>Recoger/entregar algo grande o pesado.</li>
                 <li>Compras de m√°s de 3 art√≠culos o en supermercados.</li>
                 <li>Tr√°mites que requieran tiempo o documentaci√≥n especial.</li>
             </ul>
             <p><strong>Importante:</strong> Un repartidor te contactar√° para entender los detalles y acordar un precio contigo por tel√©fono/WhatsApp. Deber√°s confirmar ese precio en la pantalla de seguimiento para iniciar el servicio.</p>`
    };

    function openDetailsModal(categoryName) {
        modalTitle.textContent = `Detalles: ${categoryName}`;
        modalDetails.innerHTML = categoryDetailsContent[categoryName] || '<p>No hay detalles disponibles.</p>';
        detailsModal.classList.add('visible'); // Usar clase para mostrar con flex
    }

    function closeDetailsModal() {
        detailsModal.classList.remove('visible');
    }

    // Cerrar modal si se hace clic fuera del contenido
    detailsModal.addEventListener('click', (event) => {
        if (event.target === detailsModal) {
            closeDetailsModal();
        }
    });
    // --- FIN L√ìGICA MODAL ---


    // --- L√ìGICA DE ENV√çO DE MANDADO (¬°ACTUALIZADA!) ---
    mandadoForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Verificar que se haya seleccionado una categor√≠a
      const selectedCategoryRadio = document.querySelector('input[name="mandado_category"]:checked');
      if (!selectedCategoryRadio) {
          alert('Por favor, selecciona un tipo de mandado.');
          return;
      }

      const boton = document.getElementById('solicitarBtn');
      boton.disabled = true;
      boton.textContent = 'Enviando...';

      try {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXyXzIAelblfS89-_uD29B4M1ksXzeUajIueaAid-11l6AO68GSNmoU7x3QHTu4xr2/exec";
        const ordenId = `M-${Math.floor(Math.random() * 90000) + 10000}`;

        if (!authenticatedUserPhone) {
            throw new Error("Error de autenticaci√≥n. No se encontr√≥ el n√∫mero de tel√©fono.");
        }

        // Determinar precio y descripci√≥n combinada
        const categoriaSeleccionada = selectedCategoryRadio.value;
        const detallesUsuario = document.getElementById('descripcion').value.trim();
        let precioFinal = "A cotizar";
        let nombreNegocioFinal = `Mandado - ${categoriaSeleccionada}`; // Usar categor√≠a como "nombre"
        let descripcionFinal = detallesUsuario; // Empezar con los detalles del usuario

        if (categoriaSeleccionada !== 'Otro') {
            precioFinal = selectedRadio.dataset.price || "Error"; // Obtener precio fijo del atributo data-price
            // Opcional: a√±adir la categor√≠a a la descripci√≥n si quieres que el repartidor la vea claramente
            // descripcionFinal = `(${categoriaSeleccionada}): ${detallesUsuario}`; 
        } else {
             nombreNegocioFinal = `Mandado - Personalizado`; // Nombre espec√≠fico para cotizar
        }


        const payload = {
          ordenId: ordenId,
          categoria: categoriaSeleccionada, // Guardar la categor√≠a seleccionada
          descripcion: descripcionFinal,   // Descripci√≥n/Detalles
          origen: document.getElementById('origen').value.trim(),
          destino: document.getElementById('destino').value.trim(),
          cliente: {
            nombre: document.getElementById('nombre').value.trim(),
            celular: authenticatedUserPhone 
          },
          // ¬°Nuevos campos para el script!
          precioUnitario: precioFinal, 
          total: precioFinal, 
          nombreNegocio: nombreNegocioFinal, // Para que aparezca en hoja Pedidos
          metodoPago: categoriaSeleccionada === 'Otro' ? 'Efectivo (a cotizar)' : 'Efectivo contra entrega'
        };

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          // ¬°IMPORTANTE! Ajustar la acci√≥n que llama el script
          body: JSON.stringify({ action: 'addMandado', payload: payload }) 
        });
        const result = await response.json();

        if (result.status === 'success') {
          notificationDiv.style.display = 'block';
          notificationDiv.innerHTML = `<h3>Solicitud Enviada ‚úÖ</h3>
            <p>Hemos recibido tu solicitud con el ID <b>${ordenId}</b>.</p>
            <p>${categoriaSeleccionada === 'Otro' ? 'Un repartidor te contactar√° para cotizar.' : 'Un repartidor ser√° asignado en breve.'}</p>
            <a href="seguimiento-mandado.html?id=${ordenId}" class="btn" style="margin-top: 1rem;">Seguir mi Mandado</a>`;
          mandadoForm.style.display = 'none';
        } else {
          throw new Error(result.message || 'Error desconocido.');
        }
      } catch (err) {
        alert(`Ocurri√≥ un error al enviar tu solicitud: ${err.message}.`);
        boton.disabled = false;
        boton.textContent = 'Enviar Solicitud';
      }
    });
    // --- FIN L√ìGICA DE ENV√çO ---

    // Llamada para marcar icono activo en barra inferior
    setActiveNavbarLink('index'); // O 'mercado' si consideras mandados parte de eso

  </script>
</body>
</html>
