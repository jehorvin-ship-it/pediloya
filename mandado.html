<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Solicitar un Mandado - PediloYa</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="auth.js"></script> 
  <link rel="stylesheet" href="styles.css">
  
  <style>
    .payment-method {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: #F5F5F5;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 1rem;
    }
    .payment-method.selected {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px var(--primary);
    }
    .payment-method .icon { font-size: 2rem; }
    .payment-method .info p { margin: 0; font-weight: 600; }
    .payment-method .info span { margin: 0; font-size: 0.9rem; color: var(--muted); }
     /* Estilo a√±adido para centrar reCAPTCHA invisible */
    #recaptcha-container {
      display: flex;
      justify-content: center; /* Centrar horizontalmente */
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
      </a>
    </div>
  </header>

  <main class="container" style="max-width: 600px;">
    <a class="back-link" href="index.html">‚Üê Volver a Inicio</a>
    <h1>Solicitar un Mandado</h1>
    
    <div id="verification-container" style="display:none;">
        <h2 style="font-size: 1.2rem; margin-top: 2rem;">Inicia Sesi√≥n para Solicitar</h2>
        <p class="muted">Verifica tu n√∫mero para continuar. Esto crear√° tu cuenta.</p>
        
        <div class="input-control">
          <label for="celular">Tu N√∫mero de Celular (Ej: 88997766)</label>
          <div class="row" style="gap: 0.5rem;">
              <span style="padding: 0.8rem; background: #F5F5F5; border-radius: 8px; font-weight: 600;">+505</span>
              <input id="celular" name="celular" type="tel" placeholder="88997766" required style="flex: 1;" />
          </div>
        </div>
        <button id="send-otp-btn" type="button" class="btn" style="width: 100%; padding: 0.9rem;">Enviar c√≥digo SMS</button>
        <p id="send-otp-error" style="color:#b94a48; margin-top: 1rem; display: none;"></p>
        <div id="recaptcha-container"></div> </div>

    <div id="otp-container" style="display:none; margin-top: 1.5rem;">
        <div class="input-control">
          <label for="otp-code">C√≥digo de 6 d√≠gitos</label>
          <input id="otp-code" type="tel" placeholder="123456" required />
        </div>
        <button id="confirm-otp-btn" type="button" class="btn" style="width: 100%; padding: 0.9rem;">Verificar y Continuar</button>
        <p id="confirm-otp-error" style="color:#b94a48; margin-top: 1rem; display: none;"></p>
    </div>

    <form id="mandadoForm" autocomplete="off" style="display:none;">
      <p id="mandado-welcome" class="muted" style="margin-top: 2rem;">¬°Est√°s solicitando como ...!</p>

      <div class="input-control">
        <label for="descripcion">¬øQu√© necesitas que hagamos?</label>
        <textarea id="descripcion" placeholder="Ej: Ir a pagar el recibo de la luz a ENATREL..." required></textarea>
      </div>
      <div class="input-control">
        <label for="origen">Direcci√≥n de Origen (si aplica)</label>
        <input id="origen" type="text" placeholder="Ej: Recoger un paquete en la terminal de buses">
      </div>
      <div class="input-control">
        <label for="destino">Direcci√≥n de Entrega</label>
        <input id="destino" type="text" placeholder="Tu direcci√≥n para entregarte el mandado" required>
      </div>

      <h2 style="font-size: 1.2rem; margin-top: 2rem;">Tus Datos de Contacto</h2>
      <div class="input-control">
        <label for="nombre">Tu Nombre Completo</label>
        <input id="nombre" type="text" placeholder="Escribe tu nombre" required />
      </div>
      
      <h2 style="font-size: 1.2rem; margin-top: 2rem;">M√©todo de Pago</h2>
      <div class="payment-method selected">
        <span class="icon">üíµ</span>
        <div class="info">
          <p>Efectivo contra entrega</p>
          <span>Pagar√°s el costo del mandado al repartidor al finalizar.</span>
        </div>
      </div>

      <button id="solicitarBtn" type="submit" class="btn" style="width: 100%; padding: 0.9rem; margin-top: 2rem;">Enviar Solicitud</button>
    </form>

    <div id="notification" style="display:none;margin-top:1.5rem; text-align: center;"></div>
  </main>

  <footer class="site-footer">¬© PediloYa</footer>

  <script src="lib.js"></script>
  <script>
    // Variables Globales
    let appVerifier = null; // Cambiado a null
    let confirmationResult;
    let authenticatedUserPhone = null; 
    // --- ¬°Variables para el temporizador de bloqueo! ---
    let blockTimerInterval = null;
    let blockSecondsRemaining = 60; 

    // Selectores del DOM
    const mandadoForm = document.getElementById('mandadoForm');
    const verificationContainer = document.getElementById('verification-container');
    const otpContainer = document.getElementById('otp-container');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const confirmOtpBtn = document.getElementById('confirm-otp-btn');
    const celularInput = document.getElementById('celular');
    const sendOtpError = document.getElementById('send-otp-error');
    const confirmOtpError = document.getElementById('confirm-otp-error');
    const notificationDiv = document.getElementById('notification');
    const recaptchaContainer = document.getElementById('recaptcha-container'); // Selector a√±adido

    // --- L√ìGICA DE CARGA DE P√ÅGINA ---
    (async () => {
      const user = await getCurrentUser(); 

      if (user) {
        // --- CASO 1: USUARIO LOGUEADO ---
        console.log("Usuario ya logueado:", user.phoneNumber);
        authenticatedUserPhone = user.phoneNumber.replace('+505', '');
        verificationContainer.style.display = 'none';
        otpContainer.style.display = 'none';
        mandadoForm.style.display = 'block';
        document.getElementById('mandado-welcome').textContent = `¬°Est√°s solicitando como ${authenticatedUserPhone}!`;
      } else {
        // --- CASO 2: USUARIO NO LOGUEADO ---
        console.log("Usuario no logueado, mostrando verificaci√≥n.");
        verificationContainer.style.display = 'block';
        
        // --- ¬°Inicializaci√≥n reCAPTCHA invisible! ---
        try {
          recaptchaContainer.innerHTML = ''; 
          appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible',
             'callback': (response) => { console.log("reCAPTCHA invisible verificado."); },
             'expired-callback': () => {
                console.warn("reCAPTCHA invisible expir√≥.");
                sendOtpError.textContent = "La verificaci√≥n expir√≥. Intenta enviar el SMS de nuevo.";
                sendOtpError.style.display = 'block';
                sendOtpBtn.disabled = false;
                sendOtpBtn.textContent = 'Enviar c√≥digo SMS';
                if (appVerifier) { appVerifier.clear(); appVerifier = null; console.log("appVerifier limpiado."); }
             }
          });
          await appVerifier.render().catch(renderError => {
             console.error("Error al renderizar reCAPTCHA invisible:", renderError);
             sendOtpError.textContent = `Error al mostrar reCAPTCHA: ${renderError.message}`;
             sendOtpError.style.display = 'block';
          });
          console.log("reCAPTCHA invisible renderizado OK.");
        } catch (e) { 
            console.error("Error cr√≠tico inicializando reCAPTCHA invisible:", e); 
            sendOtpError.textContent = `Error cr√≠tico al iniciar reCAPTCHA: ${e.message}`;
            sendOtpError.style.display = 'block';
        }
        // --- FIN Inicializaci√≥n reCAPTCHA ---
      }
    })();

    // --- ¬°L√ìGICA DE VERIFICACI√ìN CON MANEJO DE BLOQUEO! ---
    sendOtpBtn.addEventListener('click', async () => {
        // Si ya hay un temporizador activo, mostrar mensaje y salir
        if (blockTimerInterval) {
            sendOtpError.innerHTML = `‚è≥ A√∫n debes esperar <strong>${blockSecondsRemaining}</strong> segundos.`;
            sendOtpError.style.display = 'block';
            return;
        }

        const phoneNumber = celularInput.value.trim();
        if (phoneNumber.length < 8) {
            sendOtpError.textContent = 'Por favor, introduce un n√∫mero de 8 d√≠gitos.';
            return sendOtpError.style.display = 'block';
        }
        const fullPhoneNumber = `+505${phoneNumber}`;
        
        // Deshabilitar bot√≥n y limpiar errores
        sendOtpBtn.disabled = true;
        sendOtpBtn.textContent = 'Enviando SMS...';
        sendOtpError.style.display = 'none';

        if (!appVerifier) {
            sendOtpError.textContent = 'Error: El verificador reCAPTCHA no est√° listo. Recarga la p√°gina e intenta de nuevo.';
            sendOtpError.style.display = 'block';
            sendOtpBtn.disabled = false; 
            sendOtpBtn.textContent = 'Enviar c√≥digo SMS';
            console.error("Intento de enviar SMS pero appVerifier es null.");
            return; 
        }

        try {
            console.log("Llamando a signInWithPhoneNumber...");
            confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, appVerifier);
            console.log("Llamada exitosa, esperando c√≥digo OTP.");
            
            // Ocultar verificaci√≥n y mostrar OTP
            verificationContainer.style.display = 'none'; 
            otpContainer.style.display = 'block';
            document.getElementById('otp-code').focus(); 

        } catch (error) {
            console.error("Error en signInWithPhoneNumber:", error); 
            
            // --- ¬°MANEJO CREATIVO DEL ERROR 'too-many-requests'! ---
            if (error.code === 'auth/too-many-requests') {
                blockSecondsRemaining = 60; 
                sendOtpError.innerHTML = `‚è≥ ¬°Ups! Demasiados intentos. Por seguridad, espera un momento.<br>Podr√°s intentarlo de nuevo en <strong>${blockSecondsRemaining}</strong> segundos.`;
                sendOtpError.style.display = 'block';
                sendOtpBtn.textContent = 'Espera...'; 
                sendOtpBtn.disabled = true; 
                
                blockTimerInterval = setInterval(() => {
                    blockSecondsRemaining--;
                    const strongTag = sendOtpError.querySelector('strong');
                    if (strongTag) strongTag.textContent = blockSecondsRemaining;
                    
                    if (blockSecondsRemaining <= 0) {
                        clearInterval(blockTimerInterval); 
                        blockTimerInterval = null; 
                        sendOtpBtn.disabled = false; 
                        sendOtpBtn.textContent = 'Enviar c√≥digo SMS'; 
                        sendOtpError.style.display = 'none'; 
                        console.log("Temporizador de bloqueo finalizado.");
                        if (appVerifier) {
                            appVerifier.render().catch(e => console.error("Error re-render reCAPTCHA post-bloqueo:", e));
                        }
                    }
                }, 1000); 
                
            } else {
                // Mostrar otros errores de forma normal
                sendOtpError.textContent = `Error al enviar SMS: ${error.message}. Intenta de nuevo.`;
                sendOtpError.style.display = 'block';
                sendOtpBtn.disabled = false; 
                sendOtpBtn.textContent = 'Enviar c√≥digo SMS';
                if (appVerifier) {
                    appVerifier.render().catch(e => console.error("Error re-render reCAPTCHA post-error:", e));
                }
            }
            // --- FIN DEL MANEJO CREATIVO ---
        }
    });


    // --- L√≥gica de Confirmar C√≥digo OTP ---
    confirmOtpBtn.addEventListener('click', async () => {
      // (Esta funci√≥n es id√©ntica a la de mis-pedidos.html y checkout.html)
        const code = document.getElementById('otp-code').value.trim();
        if (code.length < 6) {
            confirmOtpError.textContent = 'El c√≥digo debe tener 6 d√≠gitos.';
            return confirmOtpError.style.display = 'block';
        }
        confirmOtpBtn.disabled = true;
        confirmOtpBtn.textContent = 'Verificando...';
        confirmOtpError.style.display = 'none';

        try {
            await confirmationResult.confirm(code);
            
            // ¬°√âXITO! Usuario logueado en Firebase
            confirmOtpBtn.textContent = '¬°Verificado!';
            otpContainer.style.display = 'none';
            mandadoForm.style.display = 'block';
            
            // Guardar tel√©fono en variable global
            authenticatedUserPhone = celularInput.value.trim();
            document.getElementById('mandado-welcome').textContent = `¬°Est√°s solicitando como ${authenticatedUserPhone}!`;

        } catch (error) {
            console.error("Error al verificar c√≥digo:", error);
            confirmOtpError.textContent = 'C√≥digo incorrecto o expirado. Intenta de nuevo.';
            confirmOtpError.style.display = 'block';
            confirmOtpBtn.disabled = false;
            confirmOtpBtn.textContent = 'Verificar C√≥digo';
        }
    });

    // --- L√≥gica de Enviar Mandado ---
    mandadoForm.addEventListener('submit', async (e) => {
      // (Esta funci√≥n es id√©ntica a la versi√≥n anterior, ya usaba authenticatedUserPhone)
      e.preventDefault();
      const boton = document.getElementById('solicitarBtn');
      boton.disabled = true;
      boton.textContent = 'Enviando...';

      try {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3Z-ixBkV_0Eh7sLDL8clpcsnKttk3PRixP-wrsNO0yNOoaOvLVj1UnZH7xY5caCtn/exec";
        const ordenId = `M-${Math.floor(Math.random() * 90000) + 10000}`;
        
        if (!authenticatedUserPhone) {
            throw new Error("Error de autenticaci√≥n. No se encontr√≥ el n√∫mero de tel√©fono.");
        }

        const payload = {
          ordenId: ordenId,
          descripcion: document.getElementById('descripcion').value.trim(),
          origen: document.getElementById('origen').value.trim(),
          destino: document.getElementById('destino').value.trim(),
          cliente: {
            nombre: document.getElementById('nombre').value.trim(),
            celular: authenticatedUserPhone // Usar n√∫mero autenticado
          },
          metodoPago: 'Efectivo (a cotizar)'
        };

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'addMandado', payload: payload })
        });
        const result = await response.json();

        if (result.status === 'success') {
          notificationDiv.style.display = 'block';
          notificationDiv.innerHTML = `<h3>Solicitud Enviada ‚úÖ</h3>
            <p>Hemos recibido tu solicitud con el ID <b>${ordenId}</b>.</p>
            <p>Nos pondremos en contacto contigo en breve para confirmar.</p>
            <a href="seguimiento-mandado.html?id=${ordenId}" class="btn" style="margin-top: 1rem;">Seguir mi Mandado</a>`;
          mandadoForm.style.display = 'none';
        } else {
          throw new Error(result.message || 'Error desconocido.');
        }
      } catch (err) {
        alert(`Ocurri√≥ un error al enviar tu solicitud: ${err.message}.`);
        boton.disabled = false;
        boton.textContent = 'Enviar Solicitud';
      }
    });
  </script>
</body>
</html>
