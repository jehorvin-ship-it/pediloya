<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Cuenta y Pedidos - PediloYa</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script> 
  <script src="auth.js"></script>

  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos existentes */
     #logout-btn {
        background: var(--muted);
        color: white;
        margin-left: auto;
    }
     .order-history-item {
      background: var(--card-bg);
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      display: flex; /* Mantenemos flex para alinear items */
      justify-content: space-between; /* Espacio entre contenido y botón/estado */
      align-items: center;
      /* Quitamos text-decoration global aquí */
      color: var(--dark);
      transition: box-shadow .2s ease;
    }
    .order-history-item:hover {
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }
    .order-history-item div p { margin: 0; }
    .status-tag {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      text-transform: capitalize;
      flex-shrink: 0; /* Evitar que el tag se encoja */
    }
    .status-pendiente { background-color: #ffc107; }
    .status-aceptado, .status-en-proceso, .status-listo-para-retirar { background-color: #007bff; }
    .status-entregado { background-color: #28a745; }
    .status-rechazado { background-color: #dc3545; }

    /* Estilo para el contenedor del reCAPTCHA visible */
    #recaptcha-container div {
        margin: 1rem auto 0;
    }

    /* Estilo para el enlace principal dentro del item */
    .order-link {
        text-decoration: none; /* Quitar subrayado del enlace */
        color: inherit; /* Heredar color del texto */
        display: flex; /* Alinear contenido interno */
        align-items: center;
        flex-grow: 1; /* Ocupar espacio disponible */
        margin-right: 1rem; /* Espacio antes del botón o estado */
    }
    /* Estilo específico para el botón calificar */
    .rate-btn {
        margin-left: 0.5rem; /* Pequeño espacio a la izquierda */
        padding: 0.3rem 0.8rem;
        font-size: 0.8rem;
        flex-shrink: 0; /* Evitar que el botón se encoja */
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
      </a>
    </div>
  </header>

  <main class="container" style="max-width: 600px;">
    
    <div id="login-container" style="display:none;">
      <h1>Inicia Sesión o Regístrate</h1>
      <p>Verifica tu número de celular para acceder a tu historial de pedidos y guardar tus datos.</p>
      <div class="input-control">
        <label for="celular">Tu Número de Celular (Ej: 88997766)</label>
        <div class="row" style="gap: 0.5rem;">
            <span style="padding: 0.8rem; background: #F5F5F5; border-radius: 8px; font-weight: 600;">+505</span>
            <input id="celular" name="celular" type="tel" placeholder="88997766" required style="flex: 1;" />
        </div>
      </div>
      <div id="recaptcha-container"></div>
      <button id="send-otp-btn" type="button" class="btn" style="width: 100%; padding: 0.9rem; margin-top: 1rem;" disabled>Verificar y Enviar SMS</button>
      <p id="send-otp-error" style="color:#b94a48; margin-top: 1rem; display: none;"></p>
      <div id="otp-container" style="display:none; margin-top: 1.5rem;">
          <div class="input-control">
            <label for="otp-code">Código de 6 dígitos enviado a tu celular</label>
            <input id="otp-code" type="tel" placeholder="123456" required />
          </div>
          <button id="confirm-otp-btn" type="button" class="btn" style="width: 100%; padding: 0.9rem;">Verificar e Iniciar Sesión</button>
          <p id="confirm-otp-error" style="color:#b94a48; margin-top: 1rem; display: none;"></p>
      </div>
    </div>

    <div id="account-container" style="display:none;">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1>Mis Pedidos</h1>
        <button id="logout-btn" class="btn btn--outline">Cerrar Sesión</button>
      </div>
      <p id="welcome-message" style="font-size: 1.1rem;">Cargando...</p>
      <div id="ordersList" style="margin-top: 2rem;"></div>
    </div>
    
  </main>

  <footer class="site-footer">© PediloYa</footer>
  <script src="lib.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXyXzIAelblfS89-_uD29B4M1ksXzeUajIueaAid-11l6AO68GSNmoU7x3QHTu4xr2/exec";
    
    // Selectores y Variables
    const loginContainer = document.getElementById('login-container');
    const accountContainer = document.getElementById('account-container');
    const ordersList = document.getElementById('ordersList');
    const welcomeMessage = document.getElementById('welcome-message');
    let appVerifier = null; 
    let confirmationResult;
    const celularInput = document.getElementById('celular');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const otpContainer = document.getElementById('otp-container');
    const confirmOtpBtn = document.getElementById('confirm-otp-btn');
    const sendOtpError = document.getElementById('send-otp-error');
    const confirmOtpError = document.getElementById('confirm-otp-error');
    const recaptchaContainer = document.getElementById('recaptcha-container'); 
    let blockTimerInterval = null;
    let blockSecondsRemaining = 60; 
    
    // --- LÓGICA PRINCIPAL AL CARGAR PÁGINA ---
    (async () => {
      const user = await getCurrentUser(); 

      if (user) {
        // --- CASO 1: USUARIO LOGUEADO ---
        loginContainer.style.display = 'none';
        accountContainer.style.display = 'block';
        const userPhone = user.phoneNumber.replace('+505', '');
        welcomeMessage.textContent = `Historial de: ${userPhone}`;
        await loadOrders(userPhone);
        
        // --- ¡LLAMADA A LA NUEVA FUNCIÓN PUSH! ---
        initPushNotifications(userPhone); 
        // --- FIN ---

      } else {
        // --- CASO 2: USUARIO NO LOGUEADO ---
        loginContainer.style.display = 'block';
        accountContainer.style.display = 'none';
        try {
          recaptchaContainer.innerHTML = ''; 
          appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'normal', 
            'callback': (response) => {
              console.log("reCAPTCHA VISIBLE resuelto por el usuario.");
              sendOtpBtn.disabled = false; 
              sendOtpError.style.display = 'none'; 
            },
            'expired-callback': () => {
              console.warn("reCAPTCHA VISIBLE expiró.");
              sendOtpError.textContent = "La verificación reCAPTCHA expiró. Por favor, marca la casilla de nuevo.";
              sendOtpError.style.display = 'block';
              sendOtpBtn.disabled = true; 
            }
          });
          appVerifier.render().then((widgetId) => {
            console.log("reCAPTCHA VISIBLE renderizado OK.");
          }).catch(renderError => {
             console.error("Error al renderizar reCAPTCHA VISIBLE:", renderError);
             sendOtpError.textContent = `Error al mostrar reCAPTCHA: ${renderError.message}`;
             sendOtpError.style.display = 'block';
          });
        } catch (e) { 
            console.error("Error crítico inicializando reCAPTCHA VISIBLE:", e); 
            sendOtpError.textContent = `Error crítico al iniciar reCAPTCHA: ${e.message}`;
            sendOtpError.style.display = 'block';
        }
      }
    })();

    // --- LÓGICA DE LOGIN CON MANEJO DE BLOQUEO (sin cambios) ---
    sendOtpBtn.addEventListener('click', async () => {
        // ... (código igual) ...
    });

    // --- Lógica de Confirmar Código OTP (sin cambios) ---
    confirmOtpBtn.addEventListener('click', async () => {
        // ... (código igual) ...
    });

    // --- LÓGICA DE CERRAR SESIÓN (sin cambios) ---
    document.getElementById('logout-btn').addEventListener('click', async () => {
       // ... (código igual) ...
    });

    // --- LÓGICA DE CARGAR PEDIDOS (sin cambios) ---
    async function loadOrders(phone) {
       // ... (código igual) ...
    }

    // --- FUNCIÓN RENDERORDERS CON BOTÓN CALIFICAR (sin cambios) ---
    function renderOrders(orders) {
      // ... (código igual, incluyendo la lógica del rateButtonHtml) ...
        let html = ''; 
        orders.forEach(order => {
            const statusClass = `status-${(order.Estado || '').toLowerCase().replace(/\s+/g, '-')}`;
            let linkHref = '';
            let orderTitle = '';
            let rateButtonHtml = ''; 
            if (order.NegocioID === 'MANDADO') {
                linkHref = `seguimiento-mandado.html?id=${order.ID_Pedido}`;
                orderTitle = `Servicio de Mandado - ${new Date(order.Fecha).toLocaleDateString()}`;
            } else {
                linkHref = `seguimiento.html?id=${order.ID_Pedido}`;
                orderTitle = `${order.NombreNegocio} - ${new Date(order.Fecha).toLocaleDateString()}`;
                if (order.Estado === 'Entregado') {
                    rateButtonHtml = `
                        <a href="calificar.html?pedidoId=${order.ID_Pedido}&negocioId=${order.NegocioID}" class="btn btn--outline rate-btn">
                            ⭐ Calificar
                        </a>
                    `;
                }
            }
            html += `
              <div class="order-history-item"> 
                <a href="${linkHref}" class="order-link">
                  <div>
                    <p><strong>Orden #${order.ID_Pedido}</strong></p>
                    <p>${orderTitle}</p>
                  </div>
                  <span class="status-tag ${statusClass}" style="margin-left: auto;">${order.Estado}</span> 
                </a>
                ${rateButtonHtml} 
              </div>
            `;
        });
        ordersList.innerHTML = html || '<p>Aún no tienes pedidos en tu historial.</p>'; 
    }

    // --- ¡NUEVA FUNCIÓN! PARA MANEJAR SUSCRIPCIONES PUSH ---
    async function initPushNotifications(phone) {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            console.warn('Push Notifications no soportadas en este navegador.');
            return;
        }

        try {
            // 1. Registrar el Service Worker
            // ¡Asegúrate que 'firebase-messaging-sw.js' esté en la RAÍZ de tu sitio en GitHub Pages!
            const swRegistration = await navigator.serviceWorker.register('/pediloya/firebase-messaging-sw.js'); // Ajusta la ruta si es necesario
            console.log('Service Worker registrado:', swRegistration);

            // 2. Solicitar Permiso (si aún no se ha concedido)
            console.log('Solicitando permiso de notificación...');
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                console.log('Permiso de notificación denegado.');
                // Aquí podrías mostrar un mensaje discreto al usuario si quieres
                // alert('Para recibir notificaciones sobre tus pedidos, por favor habilita los permisos en tu navegador.');
                return;
            }
            console.log('Permiso de notificación concedido.');

            // 3. Obtener el Token/Suscripción de Firebase Messaging
            const messaging = firebase.messaging();
            
            // --- ¡CLAVE VAPID PÚBLICA INSERTADA! ---
            const vapidPublicKey = 'BPyS_urU3cie0xM-kTZ2-ore92wL0cOHuySzaEsKBNi3f4t8HPnlPQZO71Gyi1DhnGKnhVRFvdmn9WkmzZ4kT_I'; 
            
            console.log('Obteniendo token FCM con VAPID Key...');
            const currentToken = await messaging.getToken({ 
                vapidKey: vapidPublicKey, 
                serviceWorkerRegistration: swRegistration // Asociar con nuestro SW registrado
            }); 

            if (currentToken) {
                console.log('Token FCM obtenido:', currentToken);
                
                // 4. Obtener la Suscripción Push detallada
                console.log('Obteniendo suscripción Push...');
                const subscription = await swRegistration.pushManager.getSubscription();
                if (subscription) {
                    // console.log('Suscripción Push:', subscription); // Log detallado opcional
                    console.log('Endpoint:', subscription.endpoint); 
                    
                    // 5. Guardar la Suscripción en Firebase Realtime DB
                    // Crear un ID único basado en el endpoint para evitar duplicados
                    // btoa puede tener caracteres no válidos para claves de Firebase ('+' o '/'), los reemplazamos
                    const subscriptionId = btoa(subscription.endpoint).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''); 
                    
                    // Apuntar a la ubicación: pushSubscriptions / numeroLocal / idDeSuscripcion
                    const subscriptionRef = db.ref(`pushSubscriptions/${phone}/${subscriptionId}`);
                    
                    // Extraer las claves necesarias para enviar el push
                    const keys = subscription.toJSON().keys;
                    if (!keys || !keys.p256dh || !keys.auth) {
                        console.error("La suscripción obtenida no contiene las claves p256dh y auth.");
                        return;
                    }

                    const subscriptionData = {
                        endpoint: subscription.endpoint,
                        keys: {
                            p256dh: keys.p256dh,
                            auth: keys.auth
                        }
                    };

                    console.log('Guardando suscripción en Firebase DB:', subscriptionData);
                    await subscriptionRef.set(subscriptionData);
                    console.log('Suscripción guardada exitosamente en Firebase DB para:', phone);
                    
                } else {
                     console.warn('No se pudo obtener la suscripción Push Manager después de obtener el token FCM.');
                }
            } else {
                console.warn('No se pudo obtener el token FCM. Revisa la configuración de `firebase-messaging-sw.js` y las claves VAPID.');
            }

        } catch (error) {
            console.error('Error detallado al inicializar notificaciones push:', error);
            // Mostrar un mensaje más específico si es posible
            if (error.code === 'messaging/permission-blocked') {
                alert('Las notificaciones están bloqueadas. Habilítalas en la configuración de tu navegador si deseas recibirlas.');
            } else if (error.code === 'messaging/failed-serviceworker-registration') {
                 alert('Error al registrar el componente de notificaciones (Service Worker). Asegúrate de estar usando HTTPS.');
            } else {
                 alert(`Ocurrió un error al configurar las notificaciones: ${error.message}`);
            }
        }
    }
    // --- FIN NUEVA FUNCIÓN ---

  </script>
</body>
</html>
