<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calificar Pedido - PediloYa</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="auth.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="lib.js"></script> <link rel="stylesheet" href="styles.css">
 <style>
    /* Estilos específicos para las estrellas */
    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 0.8rem; /* Mantenemos un espacio razonable */
      margin: 1.5rem 0;
      /* Quitamos tamaño y altura de aquí */
    }
    .star-button {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s ease;
      /* --- ¡TAMAÑO AJUSTADO! --- */
      font-size: 3rem !important;   /* Reducido de 4.5rem a 3rem (48px aprox) */
      line-height: 1 !important;    /* Mantenemos alineación */
      /* --- FIN AJUSTE --- */
      outline: none;
      /* Quitamos width/height fijos para que se ajuste al font-size */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .star-button:hover,
    .star-button.selected {
      color: #ffc107;
    }

    /* Estilo para la imagen (SE MANTIENE IGUAL que antes) */
    #product-image-container {
        margin-bottom: 1.5rem;
    }
    #product-image {
        max-width: 150px; /* Tamaño máximo de la imagen */
        max-height: 150px;
        border-radius: var(--radius);
        object-fit: cover;
        border: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
      </a>
    </div>
  </header>

  <main class="container" style="max-width: 500px; text-align: center;">
    <a class="back-link" href="mis-pedidos.html">← Volver a Mis Pedidos</a>
    
    <h1>Califica tu Pedido</h1>

    <div id="product-image-container">
        <img id="product-image" src="https://via.placeholder.com/150?text=Cargando..." alt="Imagen del producto">
    </div>

    <p id="order-info" style="font-size: 1.1rem; font-weight: 500;">
      Calificando <strong id="product-name">producto...</strong><br>
      de <strong id="negocio-name">negocio...</strong><br>
      <span style="font-size: 0.9rem; color: var(--muted);">(Pedido #<span id="pedido-id-display">...</span>)</span>
    </p>
    
    <div class="rating-stars">
      <button class="star-button" data-value="1">★</button>
      <button class="star-button" data-value="2">★</button>
      <button class="star-button" data-value="3">★</button>
      <button class="star-button" data-value="4">★</button>
      <button class="star-button" data-value="5">★</button>
    </div>

    <input type="hidden" id="selected-rating" value="0">
    <input type="hidden" id="pedido-id" value="">
    <input type="hidden" id="negocio-id" value="">

    <button id="submit-rating-btn" class="btn" style="width: 100%; padding: 0.9rem;" disabled>Enviar Calificación</button>
    
    <p id="notification" style="color: green; margin-top: 1rem; display: none;"></p>
    <p id="error-message" style="color:#b94a48; margin-top: 1rem; display: none;"></p>

  </main>

  <footer class="site-footer">© PediloYa</footer>

  <script src="lib.js"></script> 
  <script>
    // SCRIPT_URL ya no es necesaria aquí si solo usamos Firebase para guardar
    // const SCRIPT_URL = "https://..."; 

    // Elementos del DOM (sin cambios)
    const starsContainer = document.querySelector('.rating-stars');
    const starButtons = document.querySelectorAll('.star-button');
    const selectedRatingInput = document.getElementById('selected-rating');
    const pedidoIdInput = document.getElementById('pedido-id');
    const negocioIdInput = document.getElementById('negocio-id');
    const submitBtn = document.getElementById('submit-rating-btn');
    const notificationP = document.getElementById('notification');
    const errorP = document.getElementById('error-message');
    const pedidoIdDisplay = document.getElementById('pedido-id-display');
    const productNameDisplay = document.getElementById('product-name');
    const negocioNameDisplay = document.getElementById('negocio-name');
    const productImage = document.getElementById('product-image');

    let currentRating = 0;

    // --- Obtener IDs y Datos del Pedido/Negocio (sin cambios) ---
    (async () => {
        const pedidoId = qParam('pedidoId');
        const negocioId = qParam('negocioId');

        if (!pedidoId || !negocioId) {
            document.querySelector('main').innerHTML = '<h1>Error</h1><p>Falta información del pedido o negocio para calificar.</p><a href="mis-pedidos.html" class="btn">Volver</a>';
            return;
        }

        pedidoIdInput.value = pedidoId;
        negocioIdInput.value = negocioId;
        pedidoIdDisplay.textContent = pedidoId;

        try {
            const [pedidosData, negociosData, productosData] = await Promise.all([
                fetchSheetByGid(GID_PEDIDOS), 
                fetchSheetByGid(GID_NEGOCIOS),
                fetchSheetByGid(GID_PRODUCTOS)
            ]);

            const pedidoActual = pedidosData.find(p => p.ID_Pedido == pedidoId); 
            const negocioActual = negociosData.find(n => n.ID === negocioId);

            if (pedidoActual) {
                productNameDisplay.textContent = pedidoActual.Producto || 'Producto desconocido';
                const productoInfo = productosData.find(prod => prod.Nombre === pedidoActual.Producto && prod.BusinessID === negocioId);
                if (productoInfo && productoInfo.Imagen) {
                   productImage.src = productoInfo.Imagen;
                   productImage.alt = pedidoActual.Producto;
                } else if (pedidoActual.ImagenProducto) { 
                   productImage.src = pedidoActual.ImagenProducto;
                   productImage.alt = pedidoActual.Producto;
                } else {
                   productImage.src = 'https://via.placeholder.com/150?text=Sin+Imagen';
                   productImage.alt = 'Sin imagen';
                }
            } else {
                 productNameDisplay.textContent = 'Pedido no encontrado';
            }

            if (negocioActual) {
                negocioNameDisplay.textContent = negocioActual.NombreNegocio || 'Negocio desconocido';
            } else {
                 negocioNameDisplay.textContent = 'Negocio no encontrado';
            }

        } catch (fetchError) {
            console.error("Error al buscar datos del pedido/negocio:", fetchError);
            productNameDisplay.textContent = '(Error al cargar)';
            negocioNameDisplay.textContent = '(Error al cargar)';
        }
    })();


    // --- Lógica de Selección de Estrellas (sin cambios) ---
    starButtons.forEach(button => {
        button.addEventListener('mouseover', handleMouseOver);
        button.addEventListener('mouseout', handleMouseOut);
        button.addEventListener('click', handleClick);
    });
    function handleMouseOver(event) { highlightStars(parseInt(event.target.dataset.value)); }
    function handleMouseOut() { highlightStars(currentRating); }
    function handleClick(event) { 
        currentRating = parseInt(event.target.dataset.value);
        selectedRatingInput.value = currentRating;
        highlightStars(currentRating);
        submitBtn.disabled = false; 
        notificationP.style.display = 'none';
        errorP.style.display = 'none';
    }
    function highlightStars(value) {
        starButtons.forEach(star => {
            star.classList.toggle('selected', parseInt(star.dataset.value) <= value);
        });
    }

    // --- ¡NUEVA LÓGICA DE ENVÍO DE CALIFICACIÓN A FIREBASE! ---
    submitBtn.addEventListener('click', async () => {
        const rating = parseInt(selectedRatingInput.value);
        const pedidoId = pedidoIdInput.value;
        const negocioId = negocioIdInput.value;

        if (rating === 0 || !pedidoId || !negocioId) {
            errorP.textContent = "Por favor, selecciona una calificación.";
            errorP.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
        errorP.style.display = 'none';
        notificationP.style.display = 'none';

        try {
            // Creamos una referencia a la ubicación donde guardaremos la calificación
            // Usamos `pedido_${pedidoId}` para asegurarnos de que sea una clave válida
            const ratingRef = db.ref(`calificaciones/${negocioId}/pedido_${pedidoId}`); // 'db' viene de auth.js

            // Creamos el objeto a guardar
            const ratingData = {
                rating: rating,
                timestamp: firebase.database.ServerValue.TIMESTAMP // Firebase pone la hora del servidor
            };

            // Guardamos los datos en Firebase
            await ratingRef.set(ratingData);

            // Si llegamos aquí, se guardó correctamente
            notificationP.textContent = "¡Gracias por tu calificación!";
            notificationP.style.display = 'block';
            submitBtn.textContent = "Calificación Enviada 👍";
            
            // Opcional: Redirigir después de unos segundos
            setTimeout(() => { window.location.href = 'mis-pedidos.html'; }, 2000);

        } catch (error) {
            console.error("Error al enviar calificación a Firebase:", error);
            errorP.textContent = `Error al guardar: ${error.message}. Intenta de nuevo.`;
            errorP.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = "Enviar Calificación";
        }
    });
    // --- FIN DE LA NUEVA LÓGICA DE ENVÍO ---

  </script>
</body>
</html>
