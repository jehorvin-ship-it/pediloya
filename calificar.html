<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calificar Pedido - PediloYa</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="auth.js"></script>

  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos específicos para las estrellas */
    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 0.8rem; /* Aumentamos un poco el espacio */
      font-size: 3.5rem; /* ¡Estrellas mucho más grandes! */
      margin: 1.5rem 0; /* Ajustamos margen vertical */
    }
    .star-button {
      background: none;
      border: none;
      color: #ccc; 
      cursor: pointer;
      padding: 0;
      transition: color 0.2s ease;
      line-height: 1; /* Para alinear mejor las estrellas grandes */
    }
    .star-button:hover,
    .star-button.selected {
      color: #ffc107; 
    }

    /* ¡NUEVO! Estilo para la imagen del producto */
    #product-image-container {
        margin-bottom: 1.5rem;
    }
    #product-image {
        max-width: 150px; /* Tamaño máximo de la imagen */
        max-height: 150px;
        border-radius: var(--radius);
        object-fit: cover;
        border: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
      </a>
    </div>
  </header>

  <main class="container" style="max-width: 500px; text-align: center;">
    <a class="back-link" href="mis-pedidos.html">← Volver a Mis Pedidos</a>
    
    <h1>Califica tu Pedido</h1>

    <div id="product-image-container">
        <img id="product-image" src="https://via.placeholder.com/150?text=Cargando..." alt="Imagen del producto">
    </div>

    <p id="order-info" style="font-size: 1.1rem; font-weight: 500;">
      Calificando <strong id="product-name">producto...</strong><br>
      de <strong id="negocio-name">negocio...</strong><br>
      <span style="font-size: 0.9rem; color: var(--muted);">(Pedido #<span id="pedido-id-display">...</span>)</span>
    </p>
    
    <div class="rating-stars">
      <button class="star-button" data-value="1">★</button>
      <button class="star-button" data-value="2">★</button>
      <button class="star-button" data-value="3">★</button>
      <button class="star-button" data-value="4">★</button>
      <button class="star-button" data-value="5">★</button>
    </div>

    <input type="hidden" id="selected-rating" value="0">
    <input type="hidden" id="pedido-id" value="">
    <input type="hidden" id="negocio-id" value="">

    <button id="submit-rating-btn" class="btn" style="width: 100%; padding: 0.9rem;" disabled>Enviar Calificación</button>
    
    <p id="notification" style="color: green; margin-top: 1rem; display: none;"></p>
    <p id="error-message" style="color:#b94a48; margin-top: 1rem; display: none;"></p>

  </main>

  <footer class="site-footer">© PediloYa</footer>

  <script src="lib.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXyXzIAelblfS89-_uD29B4M1ksXzeUajIueaAid-11l6AO68GSNmoU7x3QHTu4xr2/exec"; 

    // Elementos del DOM
    const starsContainer = document.querySelector('.rating-stars');
    const starButtons = document.querySelectorAll('.star-button');
    const selectedRatingInput = document.getElementById('selected-rating');
    const pedidoIdInput = document.getElementById('pedido-id');
    const negocioIdInput = document.getElementById('negocio-id');
    const submitBtn = document.getElementById('submit-rating-btn');
    const notificationP = document.getElementById('notification');
    const errorP = document.getElementById('error-message');
    
    // Elementos para mostrar info (¡NUEVOS!)
    const pedidoIdDisplay = document.getElementById('pedido-id-display');
    const productNameDisplay = document.getElementById('product-name');
    const negocioNameDisplay = document.getElementById('negocio-name');
    const productImage = document.getElementById('product-image');

    let currentRating = 0;

    // --- Obtener IDs y Datos del Pedido/Negocio ---
    (async () => {
        const pedidoId = qParam('pedidoId');
        const negocioId = qParam('negocioId');

        if (!pedidoId || !negocioId) {
            document.querySelector('main').innerHTML = '<h1>Error</h1><p>Falta información del pedido o negocio para calificar.</p><a href="mis-pedidos.html" class="btn">Volver</a>';
            return;
        }

        pedidoIdInput.value = pedidoId;
        negocioIdInput.value = negocioId;
        pedidoIdDisplay.textContent = pedidoId;

        // --- ¡NUEVO! Buscar datos del pedido y negocio ---
        try {
            // Usamos Promise.all para cargar ambas hojas en paralelo
            const [pedidosData, negociosData, productosData] = await Promise.all([
                fetchSheetByGid(GID_PEDIDOS), // Necesitamos GID_PEDIDOS en lib.js
                fetchSheetByGid(GID_NEGOCIOS),
                fetchSheetByGid(GID_PRODUCTOS)
            ]);

            // Buscar el pedido específico
            const pedidoActual = pedidosData.find(p => p.ID_Pedido == pedidoId); // Usar == por si viene como número o string
            // Buscar el negocio
            const negocioActual = negociosData.find(n => n.ID === negocioId);

            if (pedidoActual) {
                productNameDisplay.textContent = pedidoActual.Producto || 'Producto desconocido';
                
                // Intentar buscar la imagen del producto en la hoja de productos
                const productoInfo = productosData.find(prod => prod.Nombre === pedidoActual.Producto && prod.BusinessID === negocioId);
                if (productoInfo && productoInfo.Imagen) {
                   productImage.src = productoInfo.Imagen;
                   productImage.alt = pedidoActual.Producto;
                } else if (pedidoActual.ImagenProducto) { // Usar imagen guardada en el pedido si existe
                   productImage.src = pedidoActual.ImagenProducto;
                   productImage.alt = pedidoActual.Producto;
                } else {
                   // Usar imagen genérica si no hay ninguna
                   productImage.src = 'https://via.placeholder.com/150?text=Sin+Imagen';
                   productImage.alt = 'Sin imagen';
                }
                
            } else {
                 productNameDisplay.textContent = 'Pedido no encontrado';
            }

            if (negocioActual) {
                negocioNameDisplay.textContent = negocioActual.NombreNegocio || 'Negocio desconocido';
            } else {
                 negocioNameDisplay.textContent = 'Negocio no encontrado';
            }

        } catch (fetchError) {
            console.error("Error al buscar datos del pedido/negocio:", fetchError);
            // Dejar los textos por defecto ("...cargando") o mostrar un mensaje
            productNameDisplay.textContent = '(Error al cargar)';
            negocioNameDisplay.textContent = '(Error al cargar)';
        }
        // --- FIN DE BUSCAR DATOS ---

    })();


    // --- Lógica de Selección de Estrellas (sin cambios) ---
    starButtons.forEach(button => {
        button.addEventListener('mouseover', handleMouseOver);
        button.addEventListener('mouseout', handleMouseOut);
        button.addEventListener('click', handleClick);
    });
    function handleMouseOver(event) { /*...*/ highlightStars(parseInt(event.target.dataset.value)); }
    function handleMouseOut() { /*...*/ highlightStars(currentRating); }
    function handleClick(event) { /*...*/ 
        currentRating = parseInt(event.target.dataset.value);
        selectedRatingInput.value = currentRating;
        highlightStars(currentRating);
        submitBtn.disabled = false; 
        notificationP.style.display = 'none';
        errorP.style.display = 'none';
    }
    function highlightStars(value) { /*...*/
        starButtons.forEach(star => {
            star.classList.toggle('selected', parseInt(star.dataset.value) <= value);
        });
    }

    // --- Lógica de Envío de Calificación (sin cambios) ---
    submitBtn.addEventListener('click', async () => {
        // ... (código igual) ...
        const rating = parseInt(selectedRatingInput.value);
        const pedidoId = pedidoIdInput.value;
        const negocioId = negocioIdInput.value;

        if (rating === 0 || !pedidoId || !negocioId) {
            errorP.textContent = "Por favor, selecciona una calificación.";
            errorP.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
        errorP.style.display = 'none';
        notificationP.style.display = 'none';

        try {
            const payload = {
                pedidoId: pedidoId,
                negocioId: negocioId,
                calificacion: rating
            };

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'addRating', payload: payload })
            });
            const result = await response.json();

            if (result.status === 'success') {
                notificationP.textContent = "¡Gracias por tu calificación!";
                notificationP.style.display = 'block';
                submitBtn.textContent = "Calificación Enviada 👍";
                // setTimeout(() => { window.location.href = 'mis-pedidos.html'; }, 2000);
            } else {
                throw new Error(result.message || 'Error desconocido del servidor.');
            }

        } catch (error) {
            console.error("Error al enviar calificación:", error);
            errorP.textContent = `Error: ${error.message}. Intenta de nuevo.`;
            errorP.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = "Enviar Calificación";
        }
    });

  </script>
</body>
</html>
