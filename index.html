<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PediloYa - Inicio</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="auth.js"></script>
  
  <link rel="stylesheet" href="styles.css">
  <script src="lib.js"></script> 
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
        <span class="brand-title">PediloYa</span>
      </a>
      <div class="search-wrap">
        <div class="search" role="search">
          <svg class="icon" viewBox="0 0 24 24" width="18" height="18"><path fill="#9CA3AF" d="M21 21l-4.35-4.35"></path></svg>
          <input id="searchInput" type="search" placeholder="Buscar negocios o productos..." aria-label="Buscar">
        </div>
      </div>
      <div class="header-actions">
        <a href="mis-pedidos.html" title="Mis Pedidos" style="font-weight: 600; color: var(--muted); text-decoration: none; font-size: 0.9rem;">üì¶ Mis Pedidos</a>
        <a href="login.html" title="Acceso para Negocios" style="font-weight: 600; color: var(--muted); text-decoration: none; font-size: 0.9rem;">üè™ Negocios</a>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <section class="hero-banner">
      <div class="hero-text">
        <h2>Almuerzos hasta C$150</h2>
        <p>Ped√≠ tu plato favorito a un precio incre√≠ble.</p>
      </div>
      <img src="https://i.ibb.co/FbBLjDhB/PLATO3-Photoroom.png" alt="Plato de comida en oferta">
    </section>

    <div id="categories" class="category-grid" aria-live="polite">
    </div>

    <h2 id="main-title">Negocios destacados</h2>
    <div id="list"><p>Cargando negocios...</p></div> 
  </main>

  <footer class="site-footer">¬© PediloYa</footer>

  <nav class="bottom-nav">
     <a href="index.html" class="nav-link active">...</a>
     <a href="mis-pedidos.html" class="nav-link">...</a>
     <a href="login.html" class="nav-link">...</a>
  </nav>

  <script>
    // Variables globales (igual que antes)
    let allNegociosActivos = [];
    let allProductos = [];
    let ratingsSummary = {}; 
    let negociosDestacados = [];
    let currentSearchTerm = ''; 

    // Selectores del DOM (igual que antes)
    const listContainer = document.getElementById('list');
    const searchInput = document.getElementById('searchInput');
    const mainTitle = document.getElementById('main-title');
    const categoriesContainer = document.getElementById('categories');

    // --- Funci√≥n para calcular resumen (sin cambios) ---
    function calculateSummaryFromFirebase(firebaseData) {
        const summary = {};
        if (!firebaseData) return summary;
        for (const negocioId in firebaseData) {
            const ratingsForNegocio = firebaseData[negocioId];
            let totalScore = 0;
            let voteCount = 0;
            for (const pedidoKey in ratingsForNegocio) {
                const ratingEntry = ratingsForNegocio[pedidoKey];
                if (ratingEntry && typeof ratingEntry.rating === 'number') {
                    totalScore += ratingEntry.rating;
                    voteCount++;
                }
            }
            if (voteCount > 0) {
                const avg = totalScore / voteCount;
                summary[negocioId] = {
                    promedio: parseFloat(avg.toFixed(1)),
                    votos: voteCount
                };
            }
        }
        return summary;
    }

    // --- ¬°NUEVA FUNCI√ìN PARA ACTUALIZAR SOLO LAS CALIFICACIONES EN LAS TARJETAS EXISTENTES! ---
    function updateRatingsOnCards(currentSummary) {
        console.log("Actualizando calificaciones en tarjetas existentes...");
        // Seleccionar todas las tarjetas de negocio que ya est√°n en el DOM
        const businessCards = listContainer.querySelectorAll('.biz-row'); 
        
        businessCards.forEach(card => {
            // Extraer el ID del negocio del enlace "Ver productos"
            const link = card.querySelector('a.btn');
            if (!link || !link.href) return;
            
            const urlParams = new URLSearchParams(link.href.split('?')[1]);
            const negocioId = urlParams.get('id');
            if (!negocioId) return;

            // Buscar el contenedor de calificaci√≥n DENTRO de esta tarjeta
            // (Si no existe, lo creamos)
            let ratingContainer = card.querySelector('.rating-display-container');
            if (!ratingContainer) {
                // Crear el contenedor si no existe y a√±adirlo despu√©s del H3
                const h3 = card.querySelector('h3');
                if (h3) {
                   ratingContainer = document.createElement('div');
                   ratingContainer.className = 'rating-display-container'; // Clase contenedora
                   h3.parentNode.insertBefore(ratingContainer, h3.nextSibling);
                } else {
                   return; // No se pudo encontrar d√≥nde insertarlo
                }
            }
            
            // Obtener los datos de calificaci√≥n para este negocio
            const ratingData = currentSummary[negocioId];
            let ratingHtml = ''; // HTML por defecto (vac√≠o)

            if (ratingData && ratingData.votos > 0) {
                ratingHtml = `
                  <div class="rating-display">
                    <span class="star-icon">‚≠ê</span>
                    <span class="rating-score">${ratingData.promedio.toFixed(1)}</span> 
                    <span class="rating-votes">(${ratingData.votos} ${ratingData.votos === 1 ? 'voto' : 'votos'})</span>
                  </div>
                `;
            }
            // Actualizar el contenido del contenedor de calificaci√≥n
            ratingContainer.innerHTML = ratingHtml; 
        });
        console.log("Calificaciones actualizadas.");
    }


    // --- Funci√≥n para renderizar lista (MODIFICADA para a√±adir contenedor de rating) ---
    function renderBusinessList(businessesToShow, currentSummary) {
        listContainer.innerHTML = '';
        if (!businessesToShow || businessesToShow.length === 0) {
            listContainer.innerHTML = '<p>No se encontraron negocios.</p>';
            return;
        }
        businessesToShow.forEach(b => {
            // Ya no pasamos currentSummary aqu√≠, createBizRow solo crea la estructura base
            listContainer.appendChild(createBizRowBase(b)); 
        });
        // Una vez creadas las tarjetas base, intentamos poner las calificaciones que tengamos
        updateRatingsOnCards(currentSummary); 
    }
    
    // --- ¬°NUEVA FUNCI√ìN! Crea la tarjeta SIN la calificaci√≥n ---
    function createBizRowBase(b) {
        const delivery = b.DeliveryFee && "" !== b.DeliveryFee ? `Delivery: C$ ${Number(b.DeliveryFee).toFixed(2)}` : "Sin delivery";
        const d = document.createElement("div");
        d.className = "biz-row";
        // Quitamos ${ratingHtml} de aqu√≠
        d.innerHTML = `
            <img src="${b.Imagen||""}" alt="${b.NombreNegocio||"Imagen negocio"}" onerror="this.src='https://via.placeholder.com/300x200?text=Sin'">
            <div>
              <h3>${b.NombreNegocio||"‚Äî"}</h3>
              <div class="rating-display-container"></div> 
              <p>${b.Categoria||""} ‚Ä¢ ${b.Horario||""}</p>
              <p>${b.Descripcion||""}</p>
              <div class="row">
                <a class="btn" href="negocio.html?id=${encodeURIComponent(b.ID)}">Ver productos</a>
                <span style="font-weight: 600; margin-left: auto;">${delivery}</span>
              </div>
            </div>`;
        return d;
    }


     // --- Funci√≥n createProductResultRow (sin cambios) ---
     function createProductResultRow(product, business) {
        // ... (c√≥digo igual) ...
     }

    // --- Funci√≥n de B√∫squeda (MODIFICADA para usar renderizado base y luego actualizar) ---
    function performSearch(q) {
        currentSearchTerm = q.toLowerCase().trim(); 
        
        if (!currentSearchTerm) {
            mainTitle.textContent = 'Negocios destacados';
            renderBusinessList(negociosDestacados, ratingsSummary); // Renderizar base y actualizar
            return;
        }

        mainTitle.textContent = `Resultados para "${currentSearchTerm}"`;
        listContainer.innerHTML = '<p>Buscando...</p>'; 

        const matchingProducts = allProductos.filter(p => /*...*/);
        const matchingBusinesses = allNegociosActivos.filter(b => /*...*/);

        listContainer.innerHTML = ''; 
        let resultsFound = false;

        if (matchingProducts.length > 0) {
            listContainer.innerHTML += '<h3>Productos Encontrados</h3>';
            matchingProducts.forEach(p => { /* ... a√±adir product row ... */ });
            resultsFound = true;
        }

        if (matchingBusinesses.length > 0) {
            listContainer.innerHTML += '<h3 style="margin-top: 1.5rem;">Negocios Encontrados</h3>';
            // ¬°Importante! Renderizar negocios encontrados SIN calificaciones primero
            matchingBusinesses.forEach(b => {
                listContainer.appendChild(createBizRowBase(b));
            });
            // Luego, intentar poner las calificaciones
            updateRatingsOnCards(ratingsSummary); 
            resultsFound = true;
        }

        if (!resultsFound) {
            listContainer.innerHTML = '<p>No se encontraron resultados para tu b√∫squeda.</p>';
        }
    }


    // --- ESTRUCTURA DE CARGA (MODIFICADA) ---

    // 1. Iniciar escucha de Firebase
    const ratingsRef = db.ref('calificaciones');
    ratingsRef.on('value', (snapshot) => {
        console.log("Datos de calificaciones recibidos/actualizados desde Firebase.");
        const firebaseData = snapshot.val(); 
        ratingsSummary = calculateSummaryFromFirebase(firebaseData); 
        
        // ¬°Importante! SOLO actualizar las tarjetas existentes, NO redibujar todo
        if (allNegociosActivos.length > 0) { // Solo si ya se cargaron los negocios
             updateRatingsOnCards(ratingsSummary);
        } else {
            console.log("Calificaciones recibidas, esperando carga de negocios.");
        }

    }, (error) => {
        console.error("Error al escuchar calificaciones de Firebase:", error);
    });

    // 2. Cargar datos de Google Sheets y renderizar base
    async function loadInitialData() {
        try {
            console.log("Iniciando carga de Negocios y Productos...");
            const [negocios, productos] = await Promise.all([
                fetchSheetByGid(GID_NEGOCIOS),
                fetchSheetByGid(GID_PRODUCTOS)
            ]);
            console.log("Negocios y Productos cargados.");

            allNegociosActivos = negocios.filter(n => (n.Estado || '1') !== '0');
            negociosDestacados = allNegociosActivos.filter(b => b.Destacado === '1');
            allProductos = productos; 

            renderCategories(); // Renderizar categor√≠as

            // Renderizar la lista INICIAL SIN calificaciones
            console.log("Renderizando lista inicial de destacados (base).");
            mainTitle.textContent = 'Negocios destacados';
            renderBusinessList(negociosDestacados, {}); // Pasar summary vac√≠o al inicio

            // El oyente de Firebase (`updateRatingsOnCards`) pondr√° las estrellas cuando lleguen.

            searchInput.addEventListener('input', (e) => performSearch(e.target.value));

        } catch (err) {
            console.error("Error en la carga inicial de datos de Sheets:", err);
            listContainer.innerHTML = '<p>Error cargando datos de negocios. Reintente.</p>';
        }
    }
    
    // Funci√≥n renderCategories (sin cambios)
    function renderCategories() { /* ... c√≥digo igual ... */ }

    // Ejecutar la carga inicial
    loadInitialData();

    // --- FIN NUEVA ESTRUCTURA ---

  </script>
</body>
</html>
