<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PediloYa - Inicio</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="auth.js"></script>
  <link rel="manifest" href="manifest.json">
  
  <link rel="stylesheet" href="styles.css">
  <script src="lib.js"></script> 
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
        <span class="brand-title">PediloYa</span>
      </a>
      <div class="search-wrap">
        <div class="search" role="search">
          <svg class="icon" viewBox="0 0 24 24" width="18" height="18"><path fill="#9CA3AF" d="M21 21l-4.35-4.35"></path></svg>
          <input id="searchInput" type="search" placeholder="Buscar negocios o productos..." aria-label="Buscar">
        </div><button id="profile-logout-button" class="profile-action" title="Cerrar Sesi√≥n" style="display: none;">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
         <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
       </svg>
     </button>
      </div>
      <div class="header-actions">
        <a href="mis-pedidos.html" title="Mis Pedidos" style="font-weight: 600; color: var(--muted); text-decoration: none; font-size: 0.9rem;">üì¶ Mis Pedidos</a>
        <a href="login.html" title="Acceso para Negocios" style="font-weight: 600; color: var(--muted); text-decoration: none; font-size: 0.9rem;">üè™ Negocios</a>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <section class="hero-banner">
      <div class="hero-text">
        <h2>Almuerzos hasta C$150</h2>
        <p>Ped√≠ tu plato favorito a un precio incre√≠ble.</p>
      </div>
      <img src="https://i.ibb.co/FbBLjDhB/PLATO3-Photoroom.png" alt="Plato de comida en oferta">
    </section>

    <div id="categories" class="category-grid" aria-live="polite">
    </div>

    <h2 id="main-title">Negocios destacados</h2>
    <div id="list"><p>Cargando negocios...</p></div> 
  </main>

  <footer class="site-footer">¬© PediloYa</footer>

  <nav class="bottom-nav">
     <a href="index.html" class="nav-link active">...</a>
     <a href="mis-pedidos.html" class="nav-link">...</a>
     <a href="login.html" class="nav-link">...</a>
  </nav>

  <script>
    // Variables globales
    let allNegociosActivos = [];
    let allProductos = [];
    let ratingsSummary = {}; 
    let negociosDestacados = [];
    let currentSearchTerm = ''; // Para saber si hay b√∫squeda activa

    // Selectores del DOM
    const listContainer = document.getElementById('list');
    const searchInput = document.getElementById('searchInput');
    const mainTitle = document.getElementById('main-title');
    const categoriesContainer = document.getElementById('categories');

    // --- Funci√≥n para calcular resumen desde Firebase (sin cambios) ---
    function calculateSummaryFromFirebase(firebaseData) {
        // ... (c√≥digo igual) ...
        const summary = {};
        if (!firebaseData) return summary;
        for (const negocioId in firebaseData) {
            const ratingsForNegocio = firebaseData[negocioId];
            let totalScore = 0;
            let voteCount = 0;
            for (const pedidoKey in ratingsForNegocio) {
                const ratingEntry = ratingsForNegocio[pedidoKey];
                if (ratingEntry && typeof ratingEntry.rating === 'number') {
                    totalScore += ratingEntry.rating;
                    voteCount++;
                }
            }
            if (voteCount > 0) {
                const avg = totalScore / voteCount;
                summary[negocioId] = {
                    promedio: parseFloat(avg.toFixed(1)),
                    votos: voteCount
                };
            }
        }
        return summary;
    }

    // --- Funci√≥n para renderizar lista (sin cambios) ---
    function renderBusinessList(businessesToShow, currentSummary) {
        // ... (c√≥digo igual) ...
        listContainer.innerHTML = '';
        if (!businessesToShow || businessesToShow.length === 0) {
            listContainer.innerHTML = '<p>No se encontraron negocios.</p>';
            return;
        }
        businessesToShow.forEach(b => {
            listContainer.appendChild(createBizRow(b, currentSummary));
        });
    }
     // --- Funci√≥n createBizRow (sin cambios) ---
     function createBizRow(b, currentSummary){ 
        // ... (c√≥digo igual) ...
        const delivery = b.DeliveryFee && "" !== b.DeliveryFee ? `Delivery: C$ ${Number(b.DeliveryFee).toFixed(2)}` : "Sin delivery";
        let ratingHtml = '';
        const ratingData = currentSummary[b.ID];
        if (ratingData && ratingData.votos > 0) { /* ... crear ratingHtml ... */ 
            ratingHtml = `<div class="rating-display"><span class="star-icon">‚≠ê</span><span class="rating-score">${ratingData.promedio.toFixed(1)}</span> <span class="rating-votes">(${ratingData.votos} ${ratingData.votos === 1 ? 'voto' : 'votos'})</span></div>`;
        }
        const d = document.createElement("div");
        d.className = "biz-row";
        d.innerHTML = `<img src="${b.Imagen||""}" ...><div><h3>${b.NombreNegocio||"‚Äî"}</h3>${ratingHtml}<p>${b.Categoria||""} ‚Ä¢ ${b.Horario||""}</p><p>${b.Descripcion||""}</p><div class="row"><a class="btn" href="negocio.html?id=${encodeURIComponent(b.ID)}">Ver productos</a><span style="font-weight: 600; margin-left: auto;">${delivery}</span></div></div>`;
        return d;
     }
     // --- Funci√≥n createProductResultRow (sin cambios) ---
     function createProductResultRow(product, business) {
        // ... (c√≥digo igual) ...
        const precio = (product.PrecioOferta && product.PrecioOferta !== '') ? Number(product.PrecioOferta) : Number(product.Precio || 0);
        const d = document.createElement('div');
        d.className = 'biz-row';
        d.innerHTML = `<img src="${product.Imagen || ''}" ...><div><h3>${product.Nombre || '‚Äî'}</h3><p>Vendido por: <strong>${business.NombreNegocio || '‚Äî'}</strong></p><p style="font-size: 1.1rem; ...">C$ ${precio.toFixed(2)}</p><div class="row" style="margin-top: 0.5rem;"><a class="btn" href="negocio.html?id=${encodeURIComponent(business.ID)}">Ir a la tienda</a></div></div>`;
        return d;
     }

    // --- Funci√≥n de B√∫squeda (Refactorizada) ---
    function performSearch(q) {
        currentSearchTerm = q.toLowerCase().trim(); // Actualizar t√©rmino global
        
        if (!currentSearchTerm) {
            mainTitle.textContent = 'Negocios destacados';
            // Renderizar solo los destacados con el summary actual
            renderBusinessList(negociosDestacados, ratingsSummary); 
            return;
        }

        mainTitle.textContent = `Resultados para "${currentSearchTerm}"`;
        listContainer.innerHTML = '<p>Buscando...</p>'; // Mostrar buscando mientras filtra

        // Filtrar productos (YA CARGADOS)
        const matchingProducts = allProductos.filter(p => 
            ((p.Nombre || '').toLowerCase().includes(currentSearchTerm)) || 
            ((p.Descripcion || '').toLowerCase().includes(currentSearchTerm))
        );
        
        // Filtrar negocios (YA CARGADOS)
        const matchingBusinesses = allNegociosActivos.filter(b => 
            (b.NombreNegocio || '').toLowerCase().includes(currentSearchTerm)
        );

        listContainer.innerHTML = ''; // Limpiar antes de mostrar resultados reales
        let resultsFound = false;

        if (matchingProducts.length > 0) {
            listContainer.innerHTML += '<h3>Productos Encontrados</h3>';
            matchingProducts.forEach(p => {
                const negocioDelProducto = allNegociosActivos.find(b => b.ID === p.BusinessID);
                if (negocioDelProducto) { 
                    listContainer.appendChild(createProductResultRow(p, negocioDelProducto)); 
                    resultsFound = true;
                }
            });
        }

        if (matchingBusinesses.length > 0) {
            listContainer.innerHTML += '<h3 style="margin-top: 1.5rem;">Negocios Encontrados</h3>';
            renderBusinessList(matchingBusinesses, ratingsSummary); // Renderizar negocios encontrados
            resultsFound = true;
        }

        if (!resultsFound) {
            listContainer.innerHTML = '<p>No se encontraron resultados para tu b√∫squeda.</p>';
        }
    }


    // --- ¬°NUEVA ESTRUCTURA DE CARGA! ---

    // 1. Iniciar escucha de Firebase INMEDIATAMENTE
    const ratingsRef = db.ref('calificaciones');
    ratingsRef.on('value', (snapshot) => {
        console.log("Datos de calificaciones recibidos/actualizados desde Firebase.");
        const firebaseData = snapshot.val(); 
        ratingsSummary = calculateSummaryFromFirebase(firebaseData); // Actualizar summary global
        
        // Si los negocios ya se cargaron, re-renderizar la lista AHORA
        if (allNegociosActivos.length > 0) {
            console.log("Re-renderizando lista con nuevas calificaciones.");
            if (currentSearchTerm) {
                performSearch(currentSearchTerm); 
            } else {
                renderBusinessList(negociosDestacados, ratingsSummary);
            }
        } else {
            console.log("Calificaciones recibidas, pero negocios a√∫n no cargados.");
        }

    }, (error) => {
        console.error("Error al escuchar calificaciones de Firebase:", error);
        // Si falla Firebase, podr√≠amos intentar renderizar sin calificaciones
        // despu√©s de que carguen los negocios, o simplemente mostrar un error.
        // Por ahora, solo logueamos el error.
    });

    // 2. Cargar datos de Google Sheets (Negocios y Productos) en paralelo
    //    y renderizar la lista inicial cuando terminen.
    async function loadInitialData() {
        try {
            console.log("Iniciando carga de Negocios y Productos desde Sheets...");
            // Usar Promise.all para cargar en paralelo
            const [negocios, productos] = await Promise.all([
                fetchSheetByGid(GID_NEGOCIOS),
                fetchSheetByGid(GID_PRODUCTOS)
            ]);
            console.log("Negocios y Productos cargados.");

            allNegociosActivos = negocios.filter(n => (n.Estado || '1') !== '0');
            negociosDestacados = allNegociosActivos.filter(b => b.Destacado === '1');
            allProductos = productos; // Guardar productos para b√∫squeda

            // Renderizar Categor√≠as (solo una vez)
            renderCategories();

            // Renderizar la lista INICIAL (destacados) usando el summary
            // que Firebase ya podr√≠a haber cargado mientras esper√°bamos a Sheets.
            console.log("Renderizando lista inicial de destacados.");
            mainTitle.textContent = 'Negocios destacados';
            renderBusinessList(negociosDestacados, ratingsSummary);

            // A√±adir listener de b√∫squeda AHORA que tenemos los datos
            searchInput.addEventListener('input', (e) => performSearch(e.target.value));

        } catch (err) {
            console.error("Error en la carga inicial de datos de Sheets:", err);
            listContainer.innerHTML = '<p>Error cargando datos de negocios. Reintente.</p>';
        }
    }
    
    // Funci√≥n separada para renderizar categor√≠as (m√°s limpio)
    function renderCategories() {
        const cats = Array.from(new Set(allNegociosActivos.map(n => n.Categoria || 'Sin categor√≠a')));
        const catImages = { /* ... tus im√°genes ... */ 
             'Restaurante': 'https://i.ibb.co/HL6tzqm9/Restarurante.png', 'Mercado': 'https://i.ibb.co/8DpZxH5h/mercado.png', 'Hogar y Servicios': 'https://i.ibb.co/G3B0gqM6/Hogar-y-Servicios.jpg', 'Farmacias': 'https://i.ibb.co/4ZzhsHk0/Farmacia.png', 'Tiendas': 'https://i.ibb.co/vxmKM3zK/tienda.png', 'Mandados': 'https://i.ibb.co/8L1BT9yL/Mandado.png',
        };
        categoriesContainer.innerHTML = ''; // Limpiar por si acaso
        cats.forEach(c => {
          const defaultImg = 'https://i.ibb.co/dKkmdT3/default-cat.png';
          const a = document.createElement('a');
          a.className = 'category-card';
          if (c === 'Mandados') { a.href = 'mandado.html'; } 
          else { a.href = `categoria.html?cat=${encodeURIComponent(c)}`; }
          a.innerHTML = `<img src="${catImages[c] || defaultImg}" alt="${c}"><span>${c}</span>`;
          categoriesContainer.appendChild(a);
        });
    }

    // Ejecutar la carga inicial de datos de Sheets
    loadInitialData();

    // --- FIN NUEVA ESTRUCTURA DE CARGA ---

  </script>
  <nav class="navbar-bottom">
  <a href="index.html" class="nav-link" data-page="index">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
    </svg>
    <span>Inicio</span>
  </a>
  <a href="categoria.html?cat=Mercado" class="nav-link" data-page="mercado"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
       <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
     </svg>
    <span>Mercado</span>
  </a>
  <a href="promociones.html" class="nav-link" data-page="promociones"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
       <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
       <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
     </svg>
    <span>Promos</span>
  </a>
  <a href="mis-pedidos.html" class="nav-link" data-page="pedidos">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <span>Pedidos</span>
  </a>
  <a href="perfil.html" class="nav-link" data-page="perfil"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
       <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
    </svg>
    <span>Mi Perfil</span>
  </a>
</nav>
</body>
</html>


