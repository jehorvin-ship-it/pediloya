<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PediloYa - Inicio</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="auth.js"></script>
  
  <link rel="stylesheet" href="styles.css">
  <script src="lib.js"></script> 
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="logo" href="index.html">
        <img src="logo.png" alt="PediloYa logo" onerror="this.style.display='none'">
        <span class="brand-title">PediloYa</span>
      </a>
      <div class="search-wrap">
        <div class="search" role="search">
          <svg class="icon" viewBox="0 0 24 24" width="18" height="18"><path fill="#9CA3AF" d="M21 21l-4.35-4.35"></path></svg>
          <input id="searchInput" type="search" placeholder="Buscar negocios o productos..." aria-label="Buscar">
        </div>
      </div>
      <div class="header-actions">
        <a href="mis-pedidos.html" title="Mis Pedidos" style="font-weight: 600; color: var(--muted); text-decoration: none; font-size: 0.9rem;">üì¶ Mis Pedidos</a>
        <a href="login.html" title="Acceso para Negocios" style="font-weight: 600; color: var(--muted); text-decoration: none; font-size: 0.9rem;">üè™ Negocios</a>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <section class="hero-banner">
      <div class="hero-text">
        <h2>Almuerzos hasta C$150</h2>
        <p>Ped√≠ tu plato favorito a un precio incre√≠ble.</p>
      </div>
      <img src="https://i.ibb.co/FbBLjDhB/PLATO3-Photoroom.png" alt="Plato de comida en oferta">
    </section>

    <div id="categories" class="category-grid" aria-live="polite">
    </div>

    <h2 id="main-title">Negocios destacados</h2>
    <div id="list"></div>
  </main>

  <footer class="site-footer">¬© PediloYa</footer>

  <nav class="bottom-nav">
    <a href="index.html" class="nav-link active">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
      <span>Inicio</span>
    </a>
    <a href="mis-pedidos.html" class="nav-link">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
      <span>Mis Pedidos</span>
    </a>
    <a href="login.html" class="nav-link">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.25a.75.75 0 01-.75-.75V10.5a.75.75 0 01.75-.75h19.5a.75.75 0 01.75.75v9.75a.75.75 0 01-.75-.75h-4.5m-7.5 0h7.5m-7.5 0l-1.5-7.5h10.5l-1.5 7.5m-7.5 0h7.5" /></svg>
      <span>Negocios</span>
    </a>
  </nav>

  <script src="lib.js"></script>
  <script>
    // Variables globales para guardar los datos cargados
    let allNegociosActivos = [];
    let allProductos = [];
    let ratingsSummary = {}; // Objeto para guardar el resumen de calificaciones
    let negociosDestacados = [];

    // Selectores del DOM
    const listContainer = document.getElementById('list');
    const searchInput = document.getElementById('searchInput');
    const mainTitle = document.getElementById('main-title');
    const categoriesContainer = document.getElementById('categories');

    // --- ¬°NUEVA FUNCI√ìN PARA CALCULAR RESUMEN DESDE FIREBASE DATA! ---
    function calculateSummaryFromFirebase(firebaseData) {
        const summary = {};
        if (!firebaseData) return summary; // Si no hay datos, devolver vac√≠o

        // Iterar sobre cada negocioId en los datos de Firebase
        for (const negocioId in firebaseData) {
            const ratingsForNegocio = firebaseData[negocioId];
            let totalScore = 0;
            let voteCount = 0;

            // Iterar sobre cada calificaci√≥n (por pedidoId) para este negocio
            for (const pedidoKey in ratingsForNegocio) {
                const ratingEntry = ratingsForNegocio[pedidoKey];
                if (ratingEntry && typeof ratingEntry.rating === 'number') {
                    totalScore += ratingEntry.rating;
                    voteCount++;
                }
            }

            // Calcular promedio si hay votos
            if (voteCount > 0) {
                const avg = totalScore / voteCount;
                summary[negocioId] = {
                    promedio: parseFloat(avg.toFixed(1)), // Redondear a 1 decimal
                    votos: voteCount
                };
            }
        }
        return summary;
    }

    // --- ¬°NUEVA FUNCI√ìN PARA RENDERIZAR LA LISTA DE NEGOCIOS! ---
    // Recibe la lista de negocios a mostrar y el resumen de calificaciones
    function renderBusinessList(businessesToShow, currentSummary) {
        listContainer.innerHTML = ''; // Limpiar lista actual
        if (!businessesToShow || businessesToShow.length === 0) {
            listContainer.innerHTML = '<p>No se encontraron negocios.</p>';
            return;
        }
        businessesToShow.forEach(b => {
            // Pasamos el resumen actual al crear cada fila
            listContainer.appendChild(createBizRow(b, currentSummary));
        });
    }


    // --- FUNCI√ìN PRINCIPAL AS√çNCRONA ---
    (async () => {
      try {
        // 1. Cargar Negocios (solo una vez al inicio)
        const negocios = await fetchSheetByGid(GID_NEGOCIOS);
        allNegociosActivos = negocios.filter(n => (n.Estado || '1') !== '0');
        negociosDestacados = allNegociosActivos.filter(b => b.Destacado === '1');

        // 2. Cargar Productos (solo una vez al inicio) - Necesario para b√∫squeda
        allProductos = await fetchSheetByGid(GID_PRODUCTOS);

        // 3. Renderizar Categor√≠as (solo una vez al inicio)
        const cats = Array.from(new Set(allNegociosActivos.map(n => n.Categoria || 'Sin categor√≠a')));
        const catImages = { /* ... tus im√°genes ... */ 
             'Restaurante': 'https://i.ibb.co/HL6tzqm9/Restarurante.png', 'Mercado': 'https://i.ibb.co/8DpZxH5h/mercado.png', 'Hogar y Servicios': 'https://i.ibb.co/G3B0gqM6/Hogar-y-Servicios.jpg', 'Farmacias': 'https://i.ibb.co/4ZzhsHk0/Farmacia.png', 'Tiendas': 'https://i.ibb.co/vxmKM3zK/tienda.png', 'Mandados': 'https://i.ibb.co/8L1BT9yL/Mandado.png',
        };
        cats.forEach(c => {
          const defaultImg = 'https://i.ibb.co/dKkmdT3/default-cat.png';
          const a = document.createElement('a');
          a.className = 'category-card';
          if (c === 'Mandados') { a.href = 'mandado.html'; } 
          else { a.href = `categoria.html?cat=${encodeURIComponent(c)}`; }
          a.innerHTML = `<img src="${catImages[c] || defaultImg}" alt="${c}"><span>${c}</span>`;
          categoriesContainer.appendChild(a);
        });

        // 4. --- ¬°NUEVO! ESCUCHAR CALIFICACIONES DE FIREBASE EN TIEMPO REAL ---
        const ratingsRef = db.ref('calificaciones'); // Apuntar a la ra√≠z de calificaciones
        ratingsRef.on('value', (snapshot) => {
            console.log("Datos de calificaciones recibidos/actualizados desde Firebase.");
            const firebaseData = snapshot.val(); // Obtener todos los datos de calificaciones
            ratingsSummary = calculateSummaryFromFirebase(firebaseData); // Calcular el nuevo resumen
            
            // VOLVER A RENDERIZAR la lista actual (destacados o resultados de b√∫squeda)
            // con el nuevo resumen de calificaciones.
            const currentSearchTerm = searchInput.value.toLowerCase().trim();
            if (currentSearchTerm) {
                // Si hay b√∫squeda activa, renderizar resultados de b√∫squeda
                performSearch(currentSearchTerm); // Reutilizar la l√≥gica de b√∫squeda
            } else {
                // Si no hay b√∫squeda, renderizar destacados
                mainTitle.textContent = 'Negocios destacados';
                renderBusinessList(negociosDestacados, ratingsSummary);
            }

        }, (error) => {
            console.error("Error al escuchar calificaciones de Firebase:", error);
            // Si falla, al menos mostrar los negocios sin calificaci√≥n
            renderBusinessList(negociosDestacados, {}); 
        });
        // --- FIN DEL OYENTE DE FIREBASE ---


        // --- L√ìGICA DE B√öSQUEDA (MODIFICADA para usar datos ya cargados) ---
        searchInput.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase().trim();
            performSearch(q); // Llamar a la funci√≥n de b√∫squeda
        });

        function performSearch(q) {
            if (!q) {
                mainTitle.textContent = 'Negocios destacados';
                renderBusinessList(negociosDestacados, ratingsSummary); // Renderizar destacados
                return;
            }

            mainTitle.textContent = `Resultados para "${q}"`;
            listContainer.innerHTML = ''; // Limpiar antes de mostrar resultados

            // Filtrar productos (usando allProductos ya cargado)
            const matchingProducts = allProductos.filter(p => 
                ((p.Nombre || '').toLowerCase().includes(q)) || 
                ((p.Descripcion || '').toLowerCase().includes(q))
            );
            
            // Filtrar negocios (usando allNegociosActivos ya cargado)
            const matchingBusinesses = allNegociosActivos.filter(b => 
                (b.NombreNegocio || '').toLowerCase().includes(q)
            );

            let resultsFound = false; // Flag para saber si hubo resultados

            if (matchingProducts.length > 0) {
                listContainer.innerHTML += '<h3>Productos Encontrados</h3>';
                matchingProducts.forEach(p => {
                    const negocioDelProducto = allNegociosActivos.find(b => b.ID === p.BusinessID);
                    if (negocioDelProducto) { 
                        listContainer.appendChild(createProductResultRow(p, negocioDelProducto)); 
                        resultsFound = true;
                    }
                });
            }

            if (matchingBusinesses.length > 0) {
                listContainer.innerHTML += '<h3 style="margin-top: 1.5rem;">Negocios Encontrados</h3>';
                // ¬°Importante! Renderizar negocios encontrados usando renderBusinessList
                renderBusinessList(matchingBusinesses, ratingsSummary); 
                resultsFound = true;
            }

            if (!resultsFound) {
                listContainer.innerHTML = '<p>No se encontraron resultados para tu b√∫squeda.</p>';
            }
        }
        // --- FIN L√ìGICA DE B√öSQUEDA ---

      } catch (err) {
        console.error("Error en la carga inicial:", err);
        document.getElementById('list').innerHTML = '<p>Error cargando datos iniciales. Reintente.</p>';
      }
    })();

    // --- Funci√≥n createProductResultRow (sin cambios) ---
    function createProductResultRow(product, business) {
      const precio = (product.PrecioOferta && product.PrecioOferta !== '') ? Number(product.PrecioOferta) : Number(product.Precio || 0);
      const d = document.createElement('div');
      d.className = 'biz-row';
      d.innerHTML = `
        <img src="${product.Imagen || ''}" alt="${product.Nombre || 'Producto'}" onerror="this.src='https://via.placeholder.com/300x200?text=Sin'">
        <div>
          <h3>${product.Nombre || '‚Äî'}</h3>
          <p>Vendido por: <strong>${business.NombreNegocio || '‚Äî'}</strong></p>
          <p style="font-size: 1.1rem; font-weight: 600; color: var(--dark);">C$ ${precio.toFixed(2)}</p>
          <div class="row" style="margin-top: 0.5rem;"><a class="btn" href="negocio.html?id=${encodeURIComponent(business.ID)}">Ir a la tienda</a></div>
        </div>`;
      return d;
    }

    // --- Funci√≥n createBizRow (SIN CAMBIOS, ya estaba lista) ---
    function createBizRow(b, currentSummary){ // Renombrado argumento para claridad
      const delivery = b.DeliveryFee && "" !== b.DeliveryFee ? `Delivery: C$ ${Number(b.DeliveryFee).toFixed(2)}` : "Sin delivery";
      let ratingHtml = '';
      const ratingData = currentSummary[b.ID]; // Usar el resumen actual

      if (ratingData && ratingData.votos > 0) {
        ratingHtml = `
          <div class="rating-display">
            <span class="star-icon">‚≠ê</span>
            <span class="rating-score">${ratingData.promedio.toFixed(1)}</span> 
            <span class="rating-votes">(${ratingData.votos} ${ratingData.votos === 1 ? 'voto' : 'votos'})</span>
          </div>
        `;
      } 
      
      const d = document.createElement("div");
      d.className = "biz-row";
      d.innerHTML = `
        <img src="${b.Imagen||""}" alt="${b.NombreNegocio||"Imagen negocio"}" onerror="this.src='https://via.placeholder.com/300x200?text=Sin'">
        <div>
          <h3>${b.NombreNegocio||"‚Äî"}</h3>
          ${ratingHtml} 
          <p>${b.Categoria||""} ‚Ä¢ ${b.Horario||""}</p>
          <p>${b.Descripcion||""}</p>
          <div class="row">
            <a class="btn" href="negocio.html?id=${encodeURIComponent(b.ID)}">Ver productos</a>
            <span style="font-weight: 600; margin-left: auto;">${delivery}</span>
          </div>
        </div>`;
      return d;
    }
  </script>
</body>
</html>
